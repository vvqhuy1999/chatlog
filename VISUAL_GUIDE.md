# ğŸ¨ Vector Database - Visual Guide (HÃ¬nh áº¢nh Minh Há»a)

## ğŸ“‹ Má»¥c Lá»¥c
1. [Quy TrÃ¬nh Chuyá»ƒn Äá»•i](#quy-trÃ¬nh-chuyá»ƒn-Ä‘á»•i)
2. [Architecture](#architecture)
3. [Data Flow](#data-flow)
4. [Search Process](#search-process)

---

## ğŸ”„ Quy TrÃ¬nh Chuyá»ƒn Äá»•i

### Pha 1: Khá»Ÿi Äá»™ng & Load Data

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  App Starts  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  VectorStoreConfig  â”‚
                â”‚  @Bean @Configuration
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Check vector_store.json â”‚
              â”‚    exists?              â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                       â”‚          â”‚
                    YESâ”‚          â”‚NO
                       â”‚          â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”   â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Load from   â”‚   â”‚ KnowledgeBaseIndexing  â”‚
            â”‚ file        â”‚   â”‚ Service @PostConstruct â”‚
            â”‚             â”‚   â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ â° 1-2s     â”‚      â”‚
            â”‚             â”‚      â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜   â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚      â”‚ Read 11 JSON Files   â”‚
                       â”‚      â”‚ Parse DataExamples   â”‚
                       â”‚      â”‚ Create Documents     â”‚
                       â”‚      â”‚ Vector HÃ³a (API call)â”‚
                       â”‚      â”‚                      â”‚
                       â”‚      â”‚ â° 30-60 phÃºt        â”‚
                       â”‚      â”‚                      â”‚
                       â”‚      â”‚ Save to              â”‚
                       â”‚      â”‚ vector_store.json    â”‚
                       â”‚      â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚         â”‚
                       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                    â”‚ Ready to Use!â”‚
                    â”‚ VectorStore  â”‚
                    â”‚ in memory    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Pha 2: Vector HÃ³a Chi Tiáº¿t

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 VECTORIZATION PROCESS                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚  File: fortigate_queries_full.json                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ Question 1: "Show failed auth..."      â”‚              â”‚
â”‚  â”‚ Question 2: "Display unsuccessful..."  â”‚              â”‚
â”‚  â”‚ Question 3: "Get failed access..."     â”‚              â”‚
â”‚  â”‚ ...                                    â”‚              â”‚
â”‚  â”‚ Question 500: ...                      â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                 â”‚                                        â”‚
â”‚              FOR EACH QUESTION                           â”‚
â”‚                 â”‚                                        â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚      â”‚ Send to OpenAI API  â”‚                            â”‚
â”‚      â”‚ Embedding Endpoint  â”‚                            â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                 â”‚                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚   â”‚ OpenAI Returns Vector:   â”‚                          â”‚
â”‚   â”‚ [-0.234, 0.891, -0.456, â”‚                          â”‚
â”‚   â”‚  0.123, 0.045, ..., ... â”‚  1536 numbers            â”‚
â”‚   â”‚  ]                       â”‚                          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                 â”‚                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚   â”‚ Create Document with:    â”‚                          â”‚
â”‚   â”‚ - content (question)     â”‚                          â”‚
â”‚   â”‚ - embedding (vector)     â”‚                          â”‚
â”‚   â”‚ - metadata (query_dsl)   â”‚                          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                 â”‚                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚   â”‚ Store in VectorStore     â”‚                          â”‚
â”‚   â”‚ (in-memory)              â”‚                          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                           â”‚
â”‚  100-200ms per question                                  â”‚
â”‚  Total for 500: ~50-100 seconds                          â”‚
â”‚                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Pha 3: LÆ°u Trá»¯ (Persistence)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          VECTOR STORE TO FILE PERSISTENCE               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  SimpleVectorStore (In-Memory)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ Doc 1: content, embedding, meta   â”‚                  â”‚
â”‚  â”‚ Doc 2: content, embedding, meta   â”‚                  â”‚
â”‚  â”‚ ...                               â”‚                  â”‚
â”‚  â”‚ Doc 2300: content, embedding, metaâ”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚             â”‚                                           â”‚
â”‚             â”‚ vectorStore.save(file)                    â”‚
â”‚             â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ vector_store.json (125 MB)        â”‚                  â”‚
â”‚  â”‚ - JSON format                     â”‚                  â”‚
â”‚  â”‚ - Contains all embeddings         â”‚                  â”‚
â”‚  â”‚ - On disk (persistent)            â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                         â”‚
â”‚  Benefits:                                              â”‚
â”‚  âœ“ Fast load on restart (1-2s)                          â”‚
â”‚  âœ“ No API calls needed again                            â”‚
â”‚  âœ“ Save costs                                           â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ï¸ Architecture

```
User sends query
       â”‚
       â–¼
REST Controller
       â”‚
       â–¼
AiComparisonService.handleRequestWithComparison()
       â”‚
       â–¼
buildDynamicExamples(userQuery)
       â”‚
       â–¼
VectorSearchService.findRelevantExamples(userQuery)
       â”‚
       â–¼
vectorStore.similaritySearch(userQuery, topK=5)
       â”‚
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”
   â”‚        â”‚
   â–¼        â–¼
1. Embed  2. Search
   Query   2300 Vectors
   â”‚        â”‚
   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚
       â–¼
3. Sort & Get Top 5
       â”‚
       â–¼
4. Format Results
       â”‚
       â–¼
Add to LLM Prompt
       â”‚
       â–¼
LLM generates better Elasticsearch query
       â”‚
       â–¼
Execute & Return Results
```

---

## ğŸ“Š Timeline

```
FIRST STARTUP (LÃ¢u ~40 phÃºt)
â”œâ”€ T+0s:    App starts
â”œâ”€ T+2s:    VectorStoreConfig created
â”œâ”€ T+3s:    KnowledgeBaseIndexingService triggered
â”œâ”€ T+10s:   Reading JSON files
â”œâ”€ T+20s:   Creating documents
â”œâ”€ T+30s:   Start embedding (OpenAI API calls)
â”œâ”€ T+2400s: Finish embedding 2300 docs
â”œâ”€ T+2410s: Save to vector_store.json
â””â”€ T+2420s: âœ… Ready!

NEXT STARTUPS (Nhanh ~2 giÃ¢y)
â”œâ”€ T+0s:    App starts
â”œâ”€ T+1s:    VectorStoreConfig created
â”œâ”€ T+1.5s:  Load file vector_store.json
â””â”€ T+2s:    âœ… Ready!

PER USER QUERY (Nhanh ~300ms)
â”œâ”€ T+0ms:   Receive query
â”œâ”€ T+100ms: Embed query (OpenAI)
â”œâ”€ T+250ms: Calculate similarity
â”œâ”€ T+300ms: Get top 5 + format
â””â”€ T+300ms: Return to service
```

---

## ğŸ” Similarity Search Detail

```
INPUT: "Show failed auth attempts"
       â”‚
       â–¼
STEP 1: Convert to Vector (1536 numbers)
       [-0.232, 0.893, -0.454, 0.122, ...]
       â”‚
       â–¼
STEP 2: Compare with All Documents
       â”‚
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                          â”‚
   â–¼                          â–¼
Doc 1 Vector:            Doc 2 Vector:
[-0.234, 0.891, ...]     [-0.245, 0.885, ...]
Similarity: 0.987        Similarity: 0.985
   â”‚                          â”‚
   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       ... (repeat for all 2300 documents)
       â”‚
       â–¼
STEP 3: Sort Results
       [0.987, 0.985, 0.750, 0.680, 0.670, ...]
       â”‚
       â–¼
STEP 4: Get Top 5
       [0.987 (Doc 1),
        0.985 (Doc 2),
        0.750 (Doc 3),
        0.680 (Doc 4),
        0.670 (Doc 5)]
       â”‚
       â–¼
OUTPUT: 5 Most Similar Documents
```

---

**Generated:** 2025-10-22
