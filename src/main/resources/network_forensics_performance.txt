đ======================================
ĐIỀU TRA MẠNG & PHÂN TÍCH HIỆU SUẤT - QUY TRÌNH XỪC LÝ
Network Forensics & Performance Analysis Playbook
Tác giả: Quản trị viên mạng cao cấp & Chuyên gia phân tích bảo mật
Phiên bản: 1.0 - Tháng 10, 2025
========================================

PHẦN I: ĐIỀU TRA MẠNG CHUYÊN SÂU (NETWORK FORENSICS)

TÌNH HUỐNG 11: PHÁT HIỆN KÊnh TRỰYỀN BÍ MẬT TRONG MẠNG (COVERT CHANNELS)
Kịch bản:
Nghi ngờ có các kênh truyền bí mật được sử dụng để đánh cắp dữ liệu qua các giao thức thông thường.

Giai đoạn 1: Phát hiện bất thường giao thức (Protocol Anomaly Detection)
{
  "keywords": ["phát hiện bất thường", "protocol anomaly", "giao thức", "network forensics"],
  "questions": [
    {
      "question": "Mô hình lưu lượng ICMP: Có kích thước payload bất thường hoặc tần suất lạ?",
      "purpose": "Phát hiện đường hầm ICMP cho việc đánh cắp dữ liệu",
      "keywords": ["đường hầm icmp", "icmp tunneling", "kênh bí mật", "đánh cắp dữ liệu", "payload bất thường"],
      "query": {
        "query": {
          "bool": {
            "filter": [
              {"range": {"@timestamp": {"gte": "now-24h"}}},
              {"term": {"network.protocol": "icmp"}}
            ]
          }
        },
        "aggs": {
          "icmp_analysis": {
            "terms": {"field": "source.ip", "size": 50},
            "aggs": {
              "packet_sizes": {
                "histogram": {
                  "field": "network.bytes",
                  "interval": 100
                }
              },
              "frequency_pattern": {
                "date_histogram": {
                  "field": "@timestamp", 
                  "fixed_interval": "1m"
                }
              },
              "unusual_payloads": {
                "bucket_selector": {
                  "buckets_path": {"avg_size": "packet_sizes>avg_bytes"},
                  "script": "params.avg_size > 1000"
                }
              },
              "regularity_score": {
                "stats": {"field": "network.bytes"}
              }
            }
          }
        }
      }
    },
    {
      "question": "Các truy vấn DNS với đặc điểm bất thường?",
      "purpose": "Phát hiện DNS covert channels và data exfiltration",
      "keywords": ["dns queries", "truy vấn dns", "đặc điểm bất thường", "covert channels", "dns tunneling"],
      "purpose": "Detect DNS tunneling and C2 communication",
      "query": {
        "query": {
          "bool": {
            "filter": [
              {"range": {"@timestamp": {"gte": "now-24h"}}},
              {"term": {"network.protocol": "dns"}}
            ]
          }
        },
        "aggs": {
          "dns_covert_analysis": {
            "terms": {"field": "source.ip", "size": 50},
            "aggs": {
              "query_patterns": {
                "terms": {"field": "url.domain", "size": 100},
                "aggs": {
                  "query_frequency": {"value_count": {"field": "@timestamp"}},
                  "domain_entropy": {
                    "bucket_script": {
                      "buckets_path": {},
                      "script": "Math.random()"
                    }
                  },
                  "subdomain_count": {
                    "cardinality": {"field": "url.subdomain"}
                  }
                }
              },
              "temporal_analysis": {
                "date_histogram": {
                  "field": "@timestamp",
                  "fixed_interval": "5m"
                },
                "aggs": {
                  "queries_per_interval": {"value_count": {"field": "@timestamp"}}
                }
              },
              "response_size_anomalies": {
                "filter": {"range": {"destination.bytes": {"gt": 512}}}
              }
            }
          }
        }
      }
    },
    {
      "question": "Lưu lượng HTTP với các dấu hiệu steganography?",
      "purpose": "Tìm kiếm dữ liệu ẩn trong HTTP traffic",
      "keywords": ["http steganography", "ẩn dữ liệu", "covert communication", "hidden data", "giấu thông tin"],
      "purpose": "Detect data hiding in normal web traffic",
      "query": {
        "query": {
          "bool": {
            "filter": [
              {"range": {"@timestamp": {"gte": "now-12h"}}},
              {"term": {"network.protocol": "http"}}
            ]
          }
        },
        "aggs": {
          "http_steganography": {
            "terms": {"field": "source.ip", "size": 30},
            "aggs": {
              "image_requests": {
                "filter": {
                  "terms": {"file.extension": ["jpg", "jpeg", "png", "gif", "bmp"]}
                },
                "aggs": {
                  "unusual_sizes": {
                    "histogram": {
                      "field": "destination.bytes",
                      "interval": 50000
                    }
                  },
                  "request_frequency": {
                    "date_histogram": {
                      "field": "@timestamp",
                      "fixed_interval": "10m"
                    }
                  }
                }
              },
              "user_agent_analysis": {
                "terms": {"field": "user_agent.original", "size": 20}
              },
              "cookie_analysis": {
                "terms": {"field": "http.request.headers.cookie", "size": 50}
              }
            }
          }
        }
      }
    }
  ]
}

Phase 2: Traffic Flow Analysis - Phân tích luồng traffic
{
  "questions": [
    {
      "question": "Lưu lượng bất đối xứng: Tỉ lệ inbound vs outbound bất thường?",
      "purpose": "Phát hiện bất thường trong chiều lưu lượng dữ liệu",
      "keywords": ["asymmetric flows", "lưu lượng bất đối xứng", "inbound outbound ratio", "traffic analysis", "data exfiltration"],
      "purpose": "Detect data exfiltration through flow asymmetry",
      "query": {
        "query": {
          "range": {"@timestamp": {"gte": "now-6h"}}
        },
        "aggs": {
          "flow_asymmetry": {
            "terms": {"field": "source.ip", "size": 100},
            "aggs": {
              "inbound_traffic": {
                "filter": {"term": {"network.direction": "inbound"}},
                "aggs": {"total_in": {"sum": {"field": "destination.bytes"}}}
              },
              "outbound_traffic": {
                "filter": {"term": {"network.direction": "outbound"}},
                "aggs": {"total_out": {"sum": {"field": "source.bytes"}}}
              },
              "asymmetry_ratio": {
                "bucket_script": {
                  "buckets_path": {
                    "inbound": "inbound_traffic>total_in",
                    "outbound": "outbound_traffic>total_out"
                  },
                  "script": "params.inbound > 0 ? params.outbound / params.inbound : 0"
                }
              },
              "suspicious_asymmetry": {
                "bucket_selector": {
                  "buckets_path": {"ratio": "asymmetry_ratio"},
                  "script": "params.ratio > 10"
                }
              }
            }
          }
        }
      }
    }
  ]
}

========================================

TÌNH HUỐNG 12: ADVANCED NETWORK RECONNAISSANCE DETECTION
Kịch bản:
Phát hiện hoạt động reconnaissance tinh vi đang map network infrastructure.

Phase 1: Passive Reconnaissance Detection - Phát hiện do thám thụ động
{
  "questions": [
    {
      "question": "Mô hình quét cổng (Port scanning): Phát hiện thăm dò có hệ thống?",
      "purpose": "Phát hiện hoạt động reconnaissance và network mapping",
      "keywords": ["port scanning", "quét cổng", "reconnaissance", "thăm dò mạng", "network probing"],
      "purpose": "Identify coordinated network reconnaissance",
      "query": {
        "query": {
          "bool": {
            "filter": [
              {"range": {"@timestamp": {"gte": "now-2h"}}},
              {"term": {"event.outcome": "deny"}}
            ]
          }
        },
        "aggs": {
          "scanning_analysis": {
            "terms": {"field": "source.ip", "size": 50},
            "aggs": {
              "scanned_targets": {
                "cardinality": {"field": "destination.ip"}
              },
              "scanned_ports": {
                "cardinality": {"field": "destination.port"}
              },
              "scan_timeline": {
                "date_histogram": {
                  "field": "@timestamp",
                  "fixed_interval": "1m"
                },
                "aggs": {
                  "ports_per_minute": {"cardinality": {"field": "destination.port"}},
                  "targets_per_minute": {"cardinality": {"field": "destination.ip"}}
                }
              },
              "scan_sophistication": {
                "bucket_script": {
                  "buckets_path": {
                    "targets": "scanned_targets",
                    "ports": "scanned_ports"
                  },
                  "script": "params.targets * params.ports"
                }
              },
              "coordinated_scan_alert": {
                "bucket_selector": {
                  "buckets_path": {"sophistication": "scan_sophistication"},
                  "script": "params.sophistication > 1000"
                }
              }
            }
          }
        }
      }
    },
    {
      "question": "Liệt kê dịch vụ (Service enumeration): Các nỗ lực xác định fingerprint ứng dụng?",
      "purpose": "Phát hiện việc thu thập thông tin về dịch vụ và ứng dụng",
      "keywords": ["service enumeration", "liệt kê dịch vụ", "application fingerprinting", "service discovery", "xác định ứng dụng"],
      "purpose": "Detect service discovery and version enumeration",
      "query": {
        "query": {
          "bool": {
            "filter": [
              {"range": {"@timestamp": {"gte": "now-6h"}}}
            ],
            "should": [
              {"wildcard": {"http.request.headers.user_agent": "*nmap*"}},
              {"wildcard": {"http.request.headers.user_agent": "*masscan*"}},
              {"wildcard": {"url.path": "*admin*"}},
              {"wildcard": {"url.path": "*config*"}},
              {"wildcard": {"url.path": "*test*"}},
              {"terms": {"destination.port": [21, 22, 23, 25, 53, 80, 110, 143, 443, 993, 995]}},
              {"exists": {"field": "tls.version_protocol"}}
            ],
            "minimum_should_match": 1
          }
        },
        "aggs": {
          "enumeration_analysis": {
            "terms": {"field": "source.ip", "size": 30},
            "aggs": {
              "services_probed": {
                "terms": {"field": "destination.port", "size": 50}
              },
              "web_enumeration": {
                "filter": {"terms": {"destination.port": [80, 443, 8080, 8443]}},
                "aggs": {
                  "paths_probed": {"terms": {"field": "url.path", "size": 100}},
                  "user_agents": {"terms": {"field": "http.request.headers.user_agent"}}
                }
              },
              "enumeration_velocity": {
                "date_histogram": {
                  "field": "@timestamp",
                  "fixed_interval": "5m"
                },
                "aggs": {
                  "requests_per_5min": {"value_count": {"field": "@timestamp"}}
                }
              }
            }
          }
        }
      }
    }
  ]
}

Phase 2: Network Topology Discovery - Phát hiện khám phá cấu trúc mạng
{
  "questions": [
    {
      "question": "Traceroute và network mapping attempts?",
      "purpose": "Detect infrastructure mapping activities",
      "query": {
        "query": {
          "bool": {
            "filter": [
              {"range": {"@timestamp": {"gte": "now-4h"}}}
            ],
            "should": [
              {"term": {"network.protocol": "icmp"}},
              {"range": {"ip.ttl": {"lte": 30}}},
              {"terms": {"destination.port": [33434, 33435, 33436]}}
            ],
            "minimum_should_match": 1
          }
        },
        "aggs": {
          "topology_discovery": {
            "terms": {"field": "source.ip", "size": 20},
            "aggs": {
              "ttl_progression": {
                "histogram": {
                  "field": "ip.ttl",
                  "interval": 1
                }
              },
              "hop_analysis": {
                "terms": {"field": "destination.ip", "size": 100},
                "aggs": {
                  "response_patterns": {"terms": {"field": "event.outcome"}}
                }
              }
            }
          }
        }
      }
    }
  ]
}

========================================

PHẦN II: PERFORMANCE ANALYSIS - PHÂN TÍCH HIỆU SUẤT MẠNG

TÌNH HUỐNG 13: DEEP PERFORMANCE BOTTLENECK ANALYSIS
Kịch bản:
Network performance degradation affects business operations. 
Cần root cause analysis và capacity planning.

Phase 1: Baseline Performance Metrics - Đo lường hiệu suất cơ bản
{
  "questions": [
    {
      "question": "Xu hướng sử dụng mạng: Hiện tại so với mức cơ bản lịch sử?",
      "purpose": "Phân tích xu hướng sử dụng mạng và capacity planning",
      "keywords": ["network utilization", "sử dụng mạng", "baseline comparison", "capacity planning", "xu hướng mạng"],
      "purpose": "Establish performance baseline and identify trends",
      "query": {
        "query": {
          "bool": {
            "should": [
              {"range": {"@timestamp": {"gte": "now-1h"}}},
              {"range": {"@timestamp": {"gte": "now-7d", "lt": "now-6d"}}}
            ]
          }
        },
        "aggs": {
          "performance_comparison": {
            "filters": {
              "filters": {
                "current_period": {"range": {"@timestamp": {"gte": "now-1h"}}},
                "baseline_period": {"range": {"@timestamp": {"gte": "now-7d", "lt": "now-6d"}}}
              }
            },
            "aggs": {
              "bandwidth_utilization": {
                "date_histogram": {
                  "field": "@timestamp",
                  "fixed_interval": "5m"
                },
                "aggs": {
                  "total_throughput": {"sum": {"field": "network.bytes"}},
                  "session_count": {"value_count": {"field": "@timestamp"}},
                  "avg_session_size": {"avg": {"field": "network.bytes"}},
                  "percentile_latency": {
                    "percentiles": {"field": "event.duration", "percents": [50, 95, 99]}
                  }
                }
              }
            }
          }
        }
      }
    },
    {
      "question": "Interface utilization: Hotspots và bottlenecks identification?",
      "purpose": "Identify network interface bottlenecks",
      "query": {
        "query": {
          "range": {"@timestamp": {"gte": "now-2h"}}
        },
        "aggs": {
          "interface_analysis": {
            "multi_terms": {
              "terms": [
                {"field": "observer.ingress.interface.name"},
                {"field": "observer.egress.interface.name"}
              ]
            },
            "aggs": {
              "traffic_volume": {"sum": {"field": "network.bytes"}},
              "packet_count": {"value_count": {"field": "@timestamp"}},
              "utilization_timeline": {
                "date_histogram": {
                  "field": "@timestamp",
                  "fixed_interval": "5m"
                },
                "aggs": {
                  "bytes_per_interval": {"sum": {"field": "network.bytes"}},
                  "utilization_percentage": {
                    "bucket_script": {
                      "buckets_path": {"bytes": "bytes_per_interval"},
                      "script": "(params.bytes * 8) / (1000000000 * 300) * 100"
                    }
                  }
                }
              },
              "congestion_indicator": {
                "filter": {"exists": {"field": "fortinet.firewall.packetloss"}},
                "aggs": {
                  "avg_packet_loss": {"avg": {"field": "fortinet.firewall.packetloss"}}
                }
              }
            }
          }
        }
      }
    }
  ]
}

Phase 2: Application Performance Impact - Tác động lên hiệu suất ứng dụng
{
  "questions": [
    {
      "question": "Application response time degradation analysis?",
      "purpose": "Correlate network performance with application metrics",
      "query": {
        "query": {
          "bool": {
            "filter": [
              {"range": {"@timestamp": {"gte": "now-4h"}}},
              {"exists": {"field": "event.duration"}}
            ]
          }
        },
        "aggs": {
          "application_performance": {
            "terms": {"field": "network.application", "size": 20},
            "aggs": {
              "response_time_stats": {
                "extended_stats": {"field": "event.duration"}
              },
              "response_time_histogram": {
                "histogram": {
                  "field": "event.duration",
                  "interval": 1000
                }
              },
              "slow_transactions": {
                "filter": {"range": {"event.duration": {"gte": 5000}}},
                "aggs": {
                  "slow_sources": {"terms": {"field": "source.ip"}},
                  "slow_destinations": {"terms": {"field": "destination.ip"}}
                }
              },
              "performance_degradation": {
                "date_histogram": {
                  "field": "@timestamp",
                  "fixed_interval": "10m"
                },
                "aggs": {
                  "avg_response_time": {"avg": {"field": "event.duration"}},
                  "p95_response_time": {
                    "percentiles": {"field": "event.duration", "percents": [95]}
                  }
                }
              }
            }
          }
        }
      }
    },
    {
      "question": "Database performance correlation với network metrics?",
      "purpose": "Analyze database-network performance relationship",
      "query": {
        "query": {
          "bool": {
            "filter": [
              {"range": {"@timestamp": {"gte": "now-2h"}}},
              {"terms": {"destination.port": [1433, 3306, 5432, 1521, 27017]}}
            ]
          }
        },
        "aggs": {
          "database_performance": {
            "multi_terms": {
              "terms": [
                {"field": "destination.ip"},
                {"field": "destination.port"}
              ]
            },
            "aggs": {
              "connection_metrics": {
                "date_histogram": {
                  "field": "@timestamp",
                  "fixed_interval": "5m"
                },
                "aggs": {
                  "active_connections": {"cardinality": {"field": "source.ip"}},
                  "query_volume": {"value_count": {"field": "@timestamp"}},
                  "data_transferred": {"sum": {"field": "network.bytes"}},
                  "avg_query_time": {"avg": {"field": "event.duration"}}
                }
              },
              "connection_pool_analysis": {
                "terms": {"field": "source.ip", "size": 50},
                "aggs": {
                  "concurrent_connections": {"value_count": {"field": "@timestamp"}},
                  "connection_duration": {"sum": {"field": "event.duration"}}
                }
              }
            }
          }
        }
      }
    }
  ]
}

Phase 3: Capacity Planning Analysis - Phân tích lập kế hoạch công suất
{
  "questions": [
    {
      "question": "Growth trend analysis: Network capacity forecasting?",
      "purpose": "Predict future capacity requirements",
      "query": {
        "query": {
          "range": {"@timestamp": {"gte": "now-30d"}}
        },
        "aggs": {
          "capacity_trend": {
            "date_histogram": {
              "field": "@timestamp",
              "calendar_interval": "1d"
            },
            "aggs": {
              "daily_peak": {
                "date_histogram": {
                  "field": "@timestamp",
                  "fixed_interval": "1h"
                },
                "aggs": {
                  "hourly_volume": {"sum": {"field": "network.bytes"}}
                }
              },
              "daily_max_throughput": {
                "max_bucket": {
                  "buckets_path": "daily_peak>hourly_volume"
                }
              },
              "daily_avg_throughput": {
                "avg_bucket": {
                  "buckets_path": "daily_peak>hourly_volume"
                }
              },
              "user_count": {
                "cardinality": {"field": "source.user.name"}
              }
            }
          }
        }
      }
    }
  ]
}

========================================

TÌNH HUỐNG 14: QoS & TRAFFIC ENGINEERING ANALYSIS
Kịch bản:
Business-critical applications experiencing performance issues. 
Cần analyze QoS effectiveness và traffic prioritization.

Phase 1: QoS Policy Effectiveness - Hiệu quả chính sách QoS
{
  "questions": [
    {
      "question": "Traffic shaping policy performance: Bandwidth allocation effectiveness?",
      "purpose": "Analyze QoS policy compliance and effectiveness",
      "query": {
        "query": {
          "bool": {
            "filter": [
              {"range": {"@timestamp": {"gte": "now-4h"}}},
              {"exists": {"field": "fortinet.firewall.shapingpolicyname"}}
            ]
          }
        },
        "aggs": {
          "qos_policy_analysis": {
            "terms": {"field": "fortinet.firewall.shapingpolicyname", "size": 20},
            "aggs": {
              "allocated_bandwidth": {
                "date_histogram": {
                  "field": "@timestamp",
                  "fixed_interval": "5m"
                },
                "aggs": {
                  "bandwidth_used": {"sum": {"field": "network.bytes"}},
                  "session_count": {"value_count": {"field": "@timestamp"}}
                }
              },
              "traffic_classes": {
                "terms": {"field": "network.application", "size": 10},
                "aggs": {
                  "class_bandwidth": {"sum": {"field": "network.bytes"}},
                  "priority_compliance": {
                    "avg": {"field": "fortinet.firewall.priority"}
                  }
                }
              },
              "policy_violations": {
                "filter": {"term": {"event.action": "traffic-shaped"}},
                "aggs": {
                  "violation_count": {"value_count": {"field": "@timestamp"}},
                  "affected_users": {"terms": {"field": "source.user.name"}}
                }
              }
            }
          }
        }
      }
    },
    {
      "question": "Business-critical vs best-effort traffic analysis?",
      "purpose": "Verify traffic prioritization effectiveness",
      "query": {
        "query": {
          "range": {"@timestamp": {"gte": "now-2h"}}
        },
        "aggs": {
          "traffic_prioritization": {
            "filters": {
              "filters": {
                "critical_apps": {
                  "terms": {"network.application": ["SAP", "Oracle", "Exchange", "VoIP"]}
                },
                "standard_apps": {
                  "terms": {"network.application": ["HTTP", "HTTPS", "FTP"]}
                },
                "bulk_transfer": {
                  "terms": {"network.application": ["BitTorrent", "Backup", "File-Share"]}
                }
              }
            },
            "aggs": {
              "performance_metrics": {
                "date_histogram": {
                  "field": "@timestamp",
                  "fixed_interval": "10m"
                },
                "aggs": {
                  "avg_latency": {"avg": {"field": "event.duration"}},
                  "throughput": {"sum": {"field": "network.bytes"}},
                  "jitter": {"extended_stats": {"field": "event.duration"}},
                  "packet_loss": {"avg": {"field": "fortinet.firewall.packetloss"}}
                }
              }
            }
          }
        }
      }
    }
  ]
}

========================================

TÌNH HUỐNG 15: BANDWIDTH ABUSE & FAIR USE MONITORING
Kịch bản:
Users complaining about slow internet. Cần identify bandwidth abusers và enforce fair use.

Phase 1: Top Bandwidth Consumers - Xác định người dùng tiêu thụ nhiều băng thông
{
  "questions": [
    {
      "question": "Top bandwidth consumers: User ranking và usage patterns?",
      "purpose": "Identify and analyze heavy bandwidth users",
      "query": {
        "query": {
          "range": {"@timestamp": {"gte": "now-24h"}}
        },
        "aggs": {
          "bandwidth_consumers": {
            "terms": {
              "field": "source.user.name",
              "size": 50,
              "order": {"total_usage": "desc"}
            },
            "aggs": {
              "total_usage": {"sum": {"field": "network.bytes"}},
              "usage_timeline": {
                "date_histogram": {
                  "field": "@timestamp",
                  "fixed_interval": "1h"
                },
                "aggs": {
                  "hourly_usage": {"sum": {"field": "network.bytes"}},
                  "peak_detection": {
                    "bucket_selector": {
                      "buckets_path": {"usage": "hourly_usage"},
                      "script": "params.usage > 1073741824"
                    }
                  }
                }
              },
              "application_breakdown": {
                "terms": {"field": "network.application", "size": 10},
                "aggs": {
                  "app_usage": {"sum": {"field": "network.bytes"}},
                  "usage_percentage": {
                    "bucket_script": {
                      "buckets_path": {
                        "app_bytes": "app_usage",
                        "total_bytes": "total_usage"
                      },
                      "script": "(params.app_bytes / params.total_bytes) * 100"
                    }
                  }
                }
              },
              "fair_use_violation": {
                "bucket_selector": {
                  "buckets_path": {"usage": "total_usage"},
                  "script": "params.usage > 5368709120"
                }
              }
            }
          }
        }
      }
    },
    {
      "question": "Streaming và P2P activity impact on network?",
      "purpose": "Quantify impact of non-business traffic",
      "query": {
        "query": {
          "bool": {
            "filter": [
              {"range": {"@timestamp": {"gte": "now-12h"}}}
            ],
            "should": [
              {"terms": {"network.application": ["YouTube", "Netflix", "BitTorrent", "Spotify"]}},
              {"wildcard": {"url.domain": "*youtube*"}},
              {"wildcard": {"url.domain": "*netflix*"}},
              {"wildcard": {"url.domain": "*twitch*"}},
              {"terms": {"destination.port": [6881, 6882, 6883, 6884, 6885]}}
            ],
            "minimum_should_match": 1
          }
        },
        "aggs": {
          "entertainment_traffic": {
            "terms": {"field": "network.application", "size": 20},
            "aggs": {
              "bandwidth_consumption": {"sum": {"field": "network.bytes"}},
              "user_count": {"cardinality": {"field": "source.user.name"}},
              "peak_usage_hours": {
                "date_histogram": {
                  "field": "@timestamp",
                  "fixed_interval": "1h"
                },
                "aggs": {
                  "hourly_bandwidth": {"sum": {"field": "network.bytes"}}
                }
              },
              "business_hours_usage": {
                "filter": {
                  "script": "doc['@timestamp'].value.getHour() >= 8 && doc['@timestamp'].value.getHour() <= 17"
                },
                "aggs": {
                  "business_hours_bandwidth": {"sum": {"field": "network.bytes"}}
                }
              }
            }
          }
        }
      }
    }
  ]
}

========================================

PHẦN III: COMPLIANCE & AUDIT QUERIES - TRUY VẤN TUÂN THỦ VÀ KIỂM TOÁN

TÌNH HUỐNG 16: REGULATORY COMPLIANCE MONITORING
Kịch bản:
Preparing for regulatory audit (GDPR, HIPAA, SOX). 
Cần demonstrate data protection và access controls.

Phase 1: Data Access Audit Trail - Kiểm toán dấu vết truy cập dữ liệu
{
  "questions": [
    {
      "question": "PII data access comprehensive audit: Who, what, when, where?",
      "purpose": "Complete audit trail for personal data access",
      "query": {
        "query": {
          "bool": {
            "filter": [
              {"range": {"@timestamp": {"gte": "now-90d"}}}
            ],
            "should": [
              {"wildcard": {"destination.ip": "10.20.*"}},
              {"terms": {"rule.category": ["customer-db", "hr-system", "financial"]}},
              {"wildcard": {"url.path": "*customer*"}},
              {"wildcard": {"url.path": "*employee*"}},
              {"wildcard": {"url.path": "*personal*"}}
            ],
            "minimum_should_match": 1
          }
        },
        "aggs": {
          "pii_access_audit": {
            "terms": {"field": "source.user.name", "size": 200},
            "aggs": {
              "access_summary": {
                "multi_terms": {
                  "terms": [
                    {"field": "destination.ip"},
                    {"field": "rule.category"}
                  ]
                },
                "aggs": {
                  "access_count": {"value_count": {"field": "@timestamp"}},
                  "first_access": {"min": {"field": "@timestamp"}},
                  "last_access": {"max": {"field": "@timestamp"}},
                  "data_volume": {"sum": {"field": "destination.bytes"}},
                  "access_pattern": {
                    "date_histogram": {
                      "field": "@timestamp",
                      "calendar_interval": "1d"
                    }
                  }
                }
              },
              "role_verification": {
                "terms": {"field": "source.user.roles"}
              },
              "business_justification": {
                "terms": {"field": "rule.name", "size": 50}
              },
              "after_hours_access": {
                "filter": {
                  "script": "doc['@timestamp'].value.getHour() < 8 || doc['@timestamp'].value.getHour() > 18"
                },
                "aggs": {
                  "after_hours_count": {"value_count": {"field": "@timestamp"}}
                }
              }
            }
          }
        }
      }
    },
    {
      "question": "Data retention compliance: Old data cleanup verification?",
      "purpose": "Verify data retention policy compliance",
      "query": {
        "query": {
          "bool": {
            "filter": [
              {"range": {"@timestamp": {"gte": "now-30d"}}},
              {"term": {"event.action": "delete"}}
            ],
            "should": [
              {"wildcard": {"message": "*retention*"}},
              {"wildcard": {"message": "*cleanup*"}},
              {"wildcard": {"message": "*purge*"}},
              {"wildcard": {"fortinet.firewall.cfgobj": "*data*"}}
            ],
            "minimum_should_match": 1
          }
        },
        "aggs": {
          "retention_compliance": {
            "date_histogram": {
              "field": "@timestamp",
              "calendar_interval": "1d"
            },
            "aggs": {
              "deletion_count": {"value_count": {"field": "@timestamp"}},
              "data_categories": {"terms": {"field": "rule.category"}},
              "deletion_operators": {"terms": {"field": "source.user.name"}},
              "automated_vs_manual": {
                "filters": {
                  "filters": {
                    "automated": {"wildcard": {"source.user.name": "*system*"}},
                    "manual": {"bool": {"must_not": {"wildcard": {"source.user.name": "*system*"}}}}
                  }
                }
              }
            }
          }
        }
      }
    }
  ]
}

========================================

SUMMARY: KEY PERFORMANCE INDICATORS (KPIs) FOR NETWORK SECURITY

1. **Security Metrics**
   - Mean Time to Detection (MTTD): < 15 minutes
   - Mean Time to Response (MTTR): < 1 hour  
   - False Positive Rate: < 5%
   - Security Coverage: > 95%

2. **Performance Metrics**
   - Network Availability: > 99.9%
   - Average Response Time: < 100ms
   - Throughput Efficiency: > 80%
   - Packet Loss Rate: < 0.1%

3. **Compliance Metrics**
   - Audit Trail Completeness: 100%
   - Policy Violation Rate: < 1%
   - Data Retention Compliance: 100%
   - Access Control Effectiveness: > 99%

4. **Operational Metrics**
   - Log Processing Rate: > 10,000 EPS
   - Storage Utilization: < 80%
   - Query Response Time: < 5 seconds
   - Dashboard Loading Time: < 3 seconds

========================================