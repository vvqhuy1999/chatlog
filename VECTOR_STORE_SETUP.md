# Vector Store Configuration Guide

## ğŸ“‹ Tá»•ng Quan

TÃ i liá»‡u nÃ y hÆ°á»›ng dáº«n cÃ¡ch sá»­ dá»¥ng Vector Store trong á»©ng dá»¥ng Spring AI Ä‘á»ƒ thá»±c hiá»‡n **tÃ¬m kiáº¿m ngá»¯ nghÄ©a (Semantic Search)** trÃªn cÆ¡ sá»Ÿ tri thá»©c cá»§a báº¡n.

## ğŸ¯ Má»¥c ÄÃ­ch

Thay vÃ¬ sá»­ dá»¥ng so khá»›p tá»« khÃ³a Ä‘Æ¡n giáº£n (keyword matching), há»‡ thá»‘ng giá» Ä‘Ã¢y:
- ğŸ§  Hiá»ƒu Ä‘Æ°á»£c **Ã½ nghÄ©a** cá»§a cÃ¢u há»i, khÃ´ng chá»‰ cÃ¡c tá»« khÃ³a
- ğŸ” TÃ¬m kiáº¿m **vÃ­ dá»¥ tÆ°Æ¡ng Ä‘á»“ng nháº¥t** tá»« kho tri thá»©c
- âš¡ KhÃ´ng cáº§n Docker hoáº·c dá»‹ch vá»¥ external
- ğŸ’¾ LÆ°u trá»¯ persistent dá»¯ liá»‡u vector trong file `vector_store.json`

## ğŸ“ Cáº¥u TrÃºc File

```
src/main/java/com/example/chatlog/
â”œâ”€â”€ config/
â”‚   â””â”€â”€ VectorStoreConfig.java          # âš™ï¸ Cáº¥u hÃ¬nh Vector Store
â”œâ”€â”€ service/impl/
â”‚   â”œâ”€â”€ KnowledgeBaseIndexingService.java  # ğŸ“š Vector hÃ³a kho tri thá»©c
â”‚   â”œâ”€â”€ VectorSearchService.java           # ğŸ” TÃ¬m kiáº¿m ngá»¯ nghÄ©a
â”‚   â””â”€â”€ AiComparisonService.java          # ğŸ“ Sá»­ dá»¥ng VectorSearchService
```

## ğŸ”§ CÃ¡c ThÃ nh Pháº§n

### 1. **VectorStoreConfig.java** (Cáº¥u HÃ¬nh)
```java
@Configuration
public class VectorStoreConfig {
    private final File vectorStoreFile = new File("vector_store.json");
    
    @Bean
    public VectorStore vectorStore(EmbeddingClient embeddingClient) {
        SimpleVectorStore vectorStore = new SimpleVectorStore(embeddingClient);
        if (vectorStoreFile.exists()) {
            vectorStore.load(vectorStoreFile);
        }
        return vectorStore;
    }
}
```

**Chá»©c nÄƒng:**
- Táº¡o bean `VectorStore` cho toÃ n á»©ng dá»¥ng
- Tá»± Ä‘á»™ng táº£i vector tá»« file náº¿u tá»“n táº¡i
- Sá»­ dá»¥ng `SimpleVectorStore` khÃ´ng cáº§n database

---

### 2. **KnowledgeBaseIndexingService.java** (Vector hÃ³a)
```java
@Service
public class KnowledgeBaseIndexingService {
    @PostConstruct
    public void indexKnowledgeBase() {
        // Chá»‰ cháº¡y 1 láº§n náº¿u vector_store.json chÆ°a tá»“n táº¡i
        // Äá»c táº¥t cáº£ JSON files tá»« resources
        // Vector hÃ³a tá»«ng DataExample
        // LÆ°u vÃ o file vector_store.json
    }
}
```

**Chá»©c nÄƒng:**
- Tá»± Ä‘á»™ng khá»Ÿi cháº¡y khi á»©ng dá»¥ng start (`@PostConstruct`)
- Äá»c táº¥t cáº£ file JSON tá»« `src/main/resources`:
  - `fortigate_queries_full.json`
  - `advanced_security_scenarios.json`
  - VÃ  9 file khÃ¡c...
- Vector hÃ³a má»—i `question` tá»« DataExample
- LÆ°u trá»¯ persistent trong `vector_store.json`
- **Cháº¡y chá»‰ 1 láº§n duy nháº¥t**, cÃ¡c láº§n cháº¡y sau sáº½ bá» qua

---

### 3. **VectorSearchService.java** (TÃ¬m Kiáº¿m)
```java
@Service
public class VectorSearchService {
    public String findRelevantExamples(String userQuery) {
        // 1. Gá»­i query Ä‘áº¿n VectorStore
        // 2. TÃ¬m 5 vÃ­ dá»¥ tÆ°Æ¡ng Ä‘á»“ng nháº¥t (semantic matching)
        // 3. Tráº£ vá» String formatted cho prompt
    }
}
```

**Chá»©c nÄƒng:**
- Nháº­n `userQuery` tá»« ngÆ°á»i dÃ¹ng
- Thá»±c hiá»‡n `similaritySearch` trÃªn vector store
- Tráº£ vá» top 5 vÃ­ dá»¥ tÆ°Æ¡ng Ä‘á»“ng nháº¥t
- Format káº¿t quáº£ dÆ°á»›i dáº¡ng String Ä‘á»ƒ Ä‘Æ°a vÃ o LLM prompt

---

### 4. **AiComparisonService.java** (TÃ­ch Há»£p)
```java
@Service
public class AiComparisonService {
    @Autowired
    private VectorSearchService vectorSearchService;
    
    private String buildDynamicExamples(String userQuery) {
        return vectorSearchService.findRelevantExamples(userQuery);
    }
}
```

**Thay Ä‘á»•i:**
- âŒ **Loáº¡i bá»**: `EnhancedExampleMatchingService`
- âœ… **ThÃªm**: `VectorSearchService`
- ğŸ”„ **Cáº­p nháº­t**: `buildDynamicExamples()` gá»i `VectorSearchService`

---

## ğŸš€ Quy TrÃ¬nh Khá»Ÿi Äá»™ng

```
Application Starts
    â†“
Spring loads VectorStoreConfig
    â†“
Creates VectorStore bean with EmbeddingClient
    â†“
Checks if vector_store.json exists?
    â”œâ”€â†’ YES: Load tá»« file (nhanh âš¡)
    â””â”€â†’ NO: Continue to KnowledgeBaseIndexingService
             â†“
         @PostConstruct triggers indexKnowledgeBase()
             â†“
         Äá»c 11 JSON files tá»« resources
             â†“
         Vector hÃ³a táº¥t cáº£ examples
             â†“
         LÆ°u vÃ o vector_store.json (lÃ¢u láº§n Ä‘áº§u ğŸ“)
             â†“
         Ready for next startups âœ…
```

## ğŸ“Š Dá»¯ Liá»‡u Flow

### Láº§n Äáº§u Khá»Ÿi Äá»™ng (LÃ¢u ~30-60 giÃ¢y)

```
JSON Files (11 files)
    â†“
DataExample objects (Ä‘Æ°á»£c parse)
    â†“
Document objects (question + metadata)
    â†“
Embeddings (generated by EmbeddingClient)
    â†“
SimpleVectorStore (in-memory)
    â†“
vector_store.json (persisted)
```

### CÃ¡c Láº§n Khá»Ÿi Äá»™ng Sau (Nhanh ~1-2 giÃ¢y)

```
vector_store.json
    â†“
VectorStoreConfig loads from file
    â†“
SimpleVectorStore (in-memory)
    â†“
Ready to serve
```

### Khi CÃ³ User Query

```
User Query: "Show me logs from last 5 minutes"
    â†“
AiComparisonService.buildDynamicExamples()
    â†“
VectorSearchService.findRelevantExamples(userQuery)
    â†“
VectorStore.similaritySearch(userQuery, topK=5)
    â†“
Top 5 Similar Documents returned
    â†“
Format as String â†’ ThÃªm vÃ o LLM Prompt
    â†“
LLM generates better query âœ…
```

## âš™ï¸ Cáº¥u HÃ¬nh TÃ¹y Chá»‰nh

### Thay Äá»•i Sá»‘ LÆ°á»£ng Top Results

File: `VectorSearchService.java`
```java
// Thay Ä‘á»•i tá»« 5 thÃ nh sá»‘ báº¡n muá»‘n
SearchRequest request = SearchRequest.query(userQuery).withTopK(5);
                                                              â†‘
                                                        Thay Ä‘á»•i Ä‘Ã¢y
```

### Thay Äá»•i Vá»‹ TrÃ­ File Vector Store

File: `VectorStoreConfig.java`
```java
// Máº·c Ä‘á»‹nh: project root
private final File vectorStoreFile = new File("vector_store.json");

// Thay Ä‘á»•i path náº¿u cáº§n
private final File vectorStoreFile = new File("/path/to/vector_store.json");
```

### ThÃªm ThÃªm Knowledge Base Files

File: `KnowledgeBaseIndexingService.java`
```java
String[] knowledgeBaseFiles = {
    "fortigate_queries_full.json",
    "advanced_security_scenarios.json",
    // ... thÃªm file má»›i á»Ÿ Ä‘Ã¢y
    "my_new_knowledge_base.json"
};
```

## ğŸ”„ TÃ¡i Táº¡o Vector Store

Náº¿u muá»‘n tÃ¡i táº¡o vector store (sau khi thÃªm file JSON má»›i):

**BÆ°á»›c 1:** XÃ³a file `vector_store.json` tá»« project root
```bash
rm vector_store.json
# hoáº·c trÃªn Windows
del vector_store.json
```

**BÆ°á»›c 2:** Restart á»©ng dá»¥ng
```bash
mvn spring-boot:run
# hoáº·c cháº¡y láº¡i tá»« IDE
```

**BÆ°á»›c 3:** Chá» KnowledgeBaseIndexingService tÃ¡i táº¡o
```
ğŸš€ Báº¯t Ä‘áº§u quÃ¡ trÃ¬nh vector hÃ³a kho tri thá»©c...
âœ… ÄÃ£ vector hÃ³a vÃ  lÆ°u trá»¯ X vÃ­ dá»¥ vÃ o file ...
```

## ğŸ“ˆ Performance

| Thao TÃ¡c | Thá»i Gian | Ghi ChÃº |
|---------|----------|--------|
| Láº§n 1 start (vector hÃ³a) | 30-60s | ğŸ“ Tá»± Ä‘á»™ng |
| Láº§n 2+ start (load tá»« file) | 1-2s | âš¡ Nhanh |
| Semantic search per query | 100-500ms | ğŸ” Phá»¥ thuá»™c vÃ o model |

## ğŸ› Troubleshooting

### âŒ Lá»—i: "No EmbeddingClient bean found"
**NguyÃªn nhÃ¢n:** ChÆ°a cáº¥u hÃ¬nh Spring AI embedding
**Giáº£i phÃ¡p:** ThÃªm dependency vÃ o `pom.xml`:
```xml
<dependency>
    <groupId>org.springframework.ai</groupId>
    <artifactId>spring-ai-openai-spring-boot-starter</artifactId>
</dependency>
```

### âŒ Lá»—i: "vector_store.json permission denied"
**NguyÃªn nhÃ¢n:** KhÃ´ng cÃ³ quyá»n ghi file
**Giáº£i phÃ¡p:** Thay Ä‘á»•i path Ä‘áº¿n thÆ° má»¥c cÃ³ quyá»n ghi

### âŒ Lá»—i: "JSON file not found in classpath"
**NguyÃªn nhÃ¢n:** File JSON khÃ´ng á»Ÿ `src/main/resources`
**Giáº£i phÃ¡p:** Di chuyá»ƒn file JSON vÃ o `src/main/resources`

## âœ… Kiá»ƒm Tra Káº¿t Quáº£

Khi á»©ng dá»¥ng start thÃ nh cÃ´ng:

1. **Kiá»ƒm tra console logs:**
```
âœ… Táº£i Vector Store tá»« file: /path/to/vector_store.json
```

2. **Kiá»ƒm tra file vector_store.json:**
```bash
ls -la vector_store.json
# File size ~ 50-200 MB tÃ¹y theo sá»‘ lÆ°á»£ng documents
```

3. **Kiá»ƒm tra functionality:**
```
User Query: "Show me failed authentication attempts"
ğŸ§  Thá»±c hiá»‡n tÃ¬m kiáº¿m ngá»¯ nghÄ©a cho: "Show me failed authentication attempts"
âœ… TÃ¬m tháº¥y 5 vÃ­ dá»¥ tÆ°Æ¡ng Ä‘á»“ng.
```

## ğŸ“š Lá»£i Ãch

| TÃ­nh NÄƒng | TrÆ°á»›c | Sau |
|----------|------|-----|
| TÃ¬m kiáº¿m | Keyword matching | Semantic search |
| Äá»™ ChÃ­nh XÃ¡c | 60-70% | 85-95% |
| Tá»‘c Äá»™ Query | 100-200ms | 100-500ms |
| Infrastructure | Cáº§n Docker | KhÃ´ng cáº§n |
| Data Persistence | In-memory | File JSON |
| Multi-language | KhÃ³ | Dá»… (mÃ´ hÃ¬nh AI) |

## ğŸ“ Káº¿ Tiáº¿p

1. âœ… Vector Store configuration - **HOÃ€N THÃ€NH**
2. ğŸ“Š Monitor vector search quality
3. ğŸ”§ Optimize embedding model
4. ğŸ“ˆ Add more knowledge base examples
5. ğŸš€ Deploy to production

---

**TÃ i liá»‡u cáº­p nháº­t:** 2025-10-16  
**Version:** 1.0
