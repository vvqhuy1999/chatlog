# üîç T·ª´ User Query ƒê·∫øn Vector Search - Chi Ti·∫øt Quy Tr√¨nh

## üìå T·ªïng Quan

```
User Input: "T√¥i mu·ªën xem c√°c l·∫ßn ƒëƒÉng nh·∫≠p th·∫•t b·∫°i"
   ‚Üì
Convert to Vector (1536 numbers)
   ‚Üì
Compare v·ªõi t·∫•t c·∫£ stored vectors (2300 documents)
   ‚Üì
Find top 5 most similar
   ‚Üì
Return k·∫øt qu·∫£
```

---

## üéØ Chi Ti·∫øt Quy Tr√¨nh (6 B∆∞·ªõc)

### B∆∞·ªõc 1Ô∏è‚É£: User G·ª≠i Query

**Controller (REST API):**
```
POST /api/chat/compare
{
  "message": "T√¥i mu·ªën xem c√°c l·∫ßn ƒëƒÉng nh·∫≠p th·∫•t b·∫°i"
}
```

**File:** `src/main/java/com/example/chatlog/controller/ChatMessagesController.java`

```java
@PostMapping("/compare")
public ResponseEntity<?> handleRequestWithComparison(
    @RequestParam Long sessionId,
    @RequestBody ChatRequest chatRequest) {
    
    // chatRequest.message = "T√¥i mu·ªën xem c√°c l·∫ßn ƒëƒÉng nh·∫≠p th·∫•t b·∫°i"
    
    return ResponseEntity.ok(
        aiComparisonService.handleRequestWithComparison(
            sessionId, 
            chatRequest
        )
    );
}
```

---

### B∆∞·ªõc 2Ô∏è‚É£: AiComparisonService X·ª≠ L√Ω

**File:** `src/main/java/com/example/chatlog/service/impl/AiComparisonService.java`

```java
public Map<String, Object> handleRequestWithComparison(Long sessionId, ChatRequest chatRequest) {
    
    // ‚≠ê B∆Ø·ªöC 2: X√¢y d·ª±ng Dynamic Examples t·ª´ Vector Search
    String dynamicExamples = buildDynamicExamples(chatRequest.message());
    
    // buildDynamicExamples() g·ªçi:
    // ‚Üí vectorSearchService.findRelevantExamples(userQuery)
    
    // ... rest c·ªßa code
}

private String buildDynamicExamples(String userQuery) {
    // ‚≠ê G·ªçi VectorSearchService
    return vectorSearchService.findRelevantExamples(userQuery);
}
```

---

### B∆∞·ªõc 3Ô∏è‚É£: VectorSearchService - Chuy·ªÉn Query Th√†nh Vector

**File:** `src/main/java/com/example/chatlog/service/impl/VectorSearchService.java`

```java
@Service
public class VectorSearchService {
    
    @Autowired
    private VectorStore vectorStore;  // ‚Üê Ch·ª©a 2300 stored vectors
    
    public String findRelevantExamples(String userQuery) {
        System.out.println("üß† Th·ª±c hi·ªán t√¨m ki·∫øm ng·ªØ nghƒ©a cho: \"" + userQuery + "\"");
        
        // ‚≠ê B∆Ø·ªöC 3: G·ªçi vectorStore.similaritySearch()
        // B√™n trong:
        // 1. Chuy·ªÉn userQuery th√†nh vector
        // 2. So s√°nh v·ªõi t·∫•t c·∫£ stored vectors
        // 3. Return top 5 most similar
        List<Document> similarDocuments = vectorStore.similaritySearch(userQuery);
        
        // ‚≠ê DEBUG: Ki·ªÉm tra k·∫øt qu·∫£ t√¨m ki·∫øm
        System.out.println("[VectorSearchService] üîç S·ªë l∆∞·ª£ng k·∫øt qu·∫£ t√¨m ƒë∆∞·ª£c: " 
            + similarDocuments.size());
        
        // ... format k·∫øt qu·∫£
        return examples.toString();
    }
}
```

---

### B∆∞·ªõc 4Ô∏è‚É£: VectorStore - Embedding Query

**B√™n Trong SimpleVectorStore.similaritySearch():**

```java
public List<Document> similaritySearch(String userQuery) {
    
    // ‚≠ê B∆Ø·ªöC 4A: EMBEDDING QUERY
    // G·ªçi EmbeddingModel ƒë·ªÉ vector h√≥a user query
    
    System.out.println("üìä User Query: " + userQuery);
    System.out.println("üîÑ Converting query to vector...");
    
    // G·ªçi OpenAI Embedding API
    EmbeddingRequest request = new EmbeddingRequest(userQuery);
    EmbeddingResponse response = embeddingModel.call(request);
    
    float[] queryVector = response.getResult()
                                  .getOutput()
                                  .toArray();
    
    System.out.println("‚úÖ Query Vector: " + queryVector.length + " dimensions");
    System.out.println("‚úÖ First 5 values: " + Arrays.toString(
        Arrays.copyOf(queryVector, 5)
    ));
    
    // queryVector = [-0.232, 0.893, -0.454, 0.122, ...]  (1536 numbers)
    
    // ‚≠ê B∆Ø·ªöC 4B: SO S√ÅNH V·ªöI T·∫§T C·∫¢ STORED VECTORS
    System.out.println("üîç Comparing with " + this.documents.size() + " stored documents...");
    
    List<SimilarityScore> scores = new ArrayList<>();
    
    // Loop qua t·ª´ng document ƒë∆∞·ª£c l∆∞u
    for (Document doc : this.documents.values()) {
        
        float[] storedVector = doc.getEmbedding().toArray();
        
        // T√≠nh Cosine Similarity
        double similarity = calculateCosineSimilarity(queryVector, storedVector);
        
        scores.add(new SimilarityScore(doc, similarity));
        
        // Log chi ti·∫øt
        System.out.println("  Document: " + doc.getMetadata().get("question"));
        System.out.println("  Similarity Score: " + String.format("%.4f", similarity));
    }
    
    // ‚≠ê B∆Ø·ªöC 4C: S·∫ÆP X·∫æP V√Ä L·∫§Y TOP K
    System.out.println("üìä Sorting results...");
    
    scores.sort((a, b) -> Double.compare(b.score, a.score));
    
    // Get top 5
    List<Document> topResults = scores.stream()
                                      .limit(5)
                                      .map(s -> s.document)
                                      .collect(Collectors.toList());
    
    System.out.println("‚úÖ Top 5 results:");
    for (int i = 0; i < topResults.size(); i++) {
        System.out.println((i+1) + ". " + topResults.get(i).getMetadata().get("question"));
    }
    
    return topResults;
}

// Cosine Similarity calculation
private double calculateCosineSimilarity(float[] a, float[] b) {
    double dotProduct = 0.0;
    double normA = 0.0;
    double normB = 0.0;
    
    for (int i = 0; i < a.length; i++) {
        dotProduct += a[i] * b[i];
        normA += a[i] * a[i];
        normB += b[i] * b[i];
    }
    
    // similarity = (A ¬∑ B) / (||A|| √ó ||B||)
    return dotProduct / (Math.sqrt(normA) * Math.sqrt(normB));
}
```

---

### B∆∞·ªõc 5Ô∏è‚É£: Format K·∫øt Qu·∫£

**Ti·∫øp t·ª•c trong VectorSearchService:**

```java
public String findRelevantExamples(String userQuery) {
    
    List<Document> similarDocuments = vectorStore.similaritySearch(userQuery);
    
    // ‚≠ê B∆Ø·ªöC 5: FORMAT K·∫æT QU·∫¢
    StringBuilder examples = new StringBuilder();
    examples.append("RELEVANT EXAMPLES FROM KNOWLEDGE BASE (Semantic Search):\n\n");
    
    for (int i = 0; i < similarDocuments.size(); i++) {
        Document doc = similarDocuments.get(i);
        
        examples.append("Example ").append(i + 1).append(":\n");
        examples.append("Question: ")
            .append(doc.getMetadata().get("question"))
            .append("\n");
        examples.append("Query: ")
            .append(doc.getMetadata().get("query_dsl"))
            .append("\n\n");
    }
    
    System.out.println("‚úÖ T√¨m th·∫•y " + similarDocuments.size() + " v√≠ d·ª• t∆∞∆°ng ƒë·ªìng.");
    
    return examples.toString();
    
    // Output:
    // RELEVANT EXAMPLES FROM KNOWLEDGE BASE (Semantic Search):
    //
    // Example 1:
    // Question: Show failed authentication attempts
    // Query: {"size": 100, "query": {"bool": {...}}}
    //
    // Example 2:
    // Question: Display unsuccessful login events
    // Query: {"size": 100, "query": {"bool": {...}}}
    // ...
}
```

---

### B∆∞·ªõc 6Ô∏è‚É£: Th√™m V√†o LLM Prompt

**Ti·∫øp t·ª•c trong AiComparisonService:**

```java
public Map<String, Object> handleRequestWithComparison(Long sessionId, ChatRequest chatRequest) {
    
    // ‚≠ê B∆Ø·ªöC 6: TH√äM V√ÄO LLM PROMPT
    String dynamicExamples = buildDynamicExamples(chatRequest.message());
    
    // dynamicExamples = "RELEVANT EXAMPLES FROM KNOWLEDGE BASE:..."
    
    String fullSystemPrompt = 
        "You are an Elasticsearch query expert.\n" +
        "Your task is to convert natural language queries into Elasticsearch queries.\n" +
        "\n" +
        "Here are examples of similar queries:\n" +
        dynamicExamples +  // ‚Üê Th√™m top 5 similar examples
        "\n" +
        "Based on the examples above, convert this query to Elasticsearch: " +
        chatRequest.message();
    
    // G·ª≠i prompt n√†y v√†o OpenAI/OpenRouter
    String openaiQuery = chatClient.prompt(
        new Prompt(List.of(
            new SystemMessage(fullSystemPrompt),
            new UserMessage(chatRequest.message())
        ))
    ).call().content();
    
    // LLM s·∫Ω xem v√≠ d·ª• t∆∞∆°ng ƒë·ªìng v√† t·∫°o query t·ªët h∆°n
    return result;
}
```

---

## üìä V√≠ D·ª• Th·ª±c T·∫ø (Real Example)

### User Input
```
"T√¥i mu·ªën xem c√°c l·∫ßn ƒëƒÉng nh·∫≠p th·∫•t b·∫°i"
```

### Query Vector (ƒë∆∞·ª£c t·∫°o b·ªüi OpenAI)
```
[-0.232, 0.893, -0.454, 0.122, -0.087, 0.456, ..., 0.234]
(1536 dimensions)
```

### Stored Vectors & Similarity Scores

| # | Question | Stored Vector | Similarity |
|---|----------|---------------|-----------|
| 1 | Show failed authentication attempts | [-0.234, 0.891, -0.456, ...] | **0.9871** ‚úÖ |
| 2 | Display unsuccessful login events | [-0.245, 0.885, -0.450, ...] | **0.9854** ‚úÖ |
| 3 | Get failed access attempts | [-0.240, 0.890, -0.455, ...] | **0.9821** ‚úÖ |
| 4 | List failed login attempts | [-0.228, 0.896, -0.451, ...] | **0.9798** ‚úÖ |
| 5 | Show authentication failures | [-0.235, 0.892, -0.457, ...] | **0.9765** ‚úÖ |
| 999 | Get user list | [0.800, -0.200, 0.100, ...] | 0.1234 ‚ùå |
| 1500 | Show server logs | [0.500, 0.300, -0.400, ...] | 0.2456 ‚ùå |

### Output cho User

```
RELEVANT EXAMPLES FROM KNOWLEDGE BASE (Semantic Search):

Example 1:
Question: Show failed authentication attempts
Query: {
  "size": 100,
  "query": {
    "bool": {
      "must": [
        {"match": {"action": "failed"}},
        {"match": {"event_type": "authentication"}}
      ]
    }
  }
}

Example 2:
Question: Display unsuccessful login events
Query: {
  "size": 100,
  "query": {
    "bool": {
      "must": [
        {"match": {"result": "failure"}},
        {"match": {"event": "login"}}
      ]
    }
  }
}

...
```

### LLM Prompt (v·ªõi Examples)

```
You are an Elasticsearch query expert.

Here are similar queries:
Example 1: Show failed authentication attempts ‚Üí {...query1...}
Example 2: Display unsuccessful login events ‚Üí {...query2...}
Example 3: Get failed access attempts ‚Üí {...query3...}
Example 4: List failed login attempts ‚Üí {...query4...}
Example 5: Show authentication failures ‚Üí {...query5...}

Convert this to Elasticsearch: "T√¥i mu·ªën xem c√°c l·∫ßn ƒëƒÉng nh·∫≠p th·∫•t b·∫°i"

Response:
{
  "size": 100,
  "query": {
    "bool": {
      "must": [
        {"match": {"result": "failed"}},
        {"match": {"event_type": "login"}}
      ],
      "filter": {
        "range": {
          "timestamp": {"gte": "now-24h"}
        }
      }
    }
  }
}
```

---

## ‚öôÔ∏è Similarity Calculation Chi Ti·∫øt

### Cosine Similarity Formula

```
Similarity = (A ¬∑ B) / (||A|| √ó ||B||)

Trong ƒë√≥:
- A = Query Vector (1536 dimensions)
- B = Stored Document Vector (1536 dimensions)
- A ¬∑ B = Dot Product (t·ªïng t√≠ch t·ª´ng ph·∫ßn t·ª≠)
- ||A|| = Magnitude/Length of A
- ||B|| = Magnitude/Length of B

K·∫øt qu·∫£: 0.0 (ho√†n to√†n kh√°c) ‚Üí 1.0 (gi·ªëng 100%)
```

### V√≠ D·ª• ƒê∆°n Gi·∫£n (3 dimensions)

```
Query Vector:    [0.5, 0.3, 0.2]
Doc 1 Vector:    [0.5, 0.3, 0.2]
Doc 2 Vector:    [0.4, 0.2, 0.15]
Doc 3 Vector:    [0.1, 0.1, 0.1]

T√≠nh Doc 1:
- A ¬∑ B = (0.5√ó0.5) + (0.3√ó0.3) + (0.2√ó0.2) = 0.38
- ||A|| = ‚àö(0.25 + 0.09 + 0.04) = 0.655
- ||B|| = ‚àö(0.25 + 0.09 + 0.04) = 0.655
- Similarity = 0.38 / (0.655 √ó 0.655) = 0.888

T√≠nh Doc 2:
- A ¬∑ B = (0.5√ó0.4) + (0.3√ó0.2) + (0.2√ó0.15) = 0.29
- ||A|| = 0.655
- ||B|| = ‚àö(0.16 + 0.04 + 0.0225) = 0.468
- Similarity = 0.29 / (0.655 √ó 0.468) = 0.943

T√≠nh Doc 3:
- A ¬∑ B = (0.5√ó0.1) + (0.3√ó0.1) + (0.2√ó0.1) = 0.1
- ||A|| = 0.655
- ||B|| = ‚àö(0.01 + 0.01 + 0.01) = 0.173
- Similarity = 0.1 / (0.655 √ó 0.173) = 0.884

Top 1: Doc 2 (0.943) ‚Üê Gi·ªëng nh·∫•t!
```

---

## ‚è±Ô∏è Timeline

```
T+0ms:   User g·ª≠i query
T+50ms:  AiComparisonService nh·∫≠n request
T+100ms: VectorSearchService.findRelevantExamples() g·ªçi
T+150ms: vectorStore.similaritySearch() g·ªçi
T+200ms: EmbeddingModel embed query
T+350ms: OpenAI tr·∫£ v·ªÅ vector query
T+360ms: Loop qua 2300 stored vectors
T+460ms: T√≠nh similarity cho t·∫•t c·∫£
T+500ms: Sort k·∫øt qu·∫£
T+510ms: Get top 5
T+520ms: Format output
T+530ms: Return examples string
T+600ms: AiComparisonService th√™m v√†o LLM prompt
T+700ms: G·ª≠i prompt ƒë·∫øn OpenAI
T+3500ms: OpenAI tr·∫£ v·ªÅ Elasticsearch query
T+3600ms: Return final response

Total: ~3.6 gi√¢y (ph·∫ßn l·ªõn l√† ch·ªù LLM)
Semantic Search: ~530ms (r·∫•t nhanh!)
```

---

## üîÑ Code Flow Diagram

```
ChatController
  ‚îî‚îÄ POST /compare
     ‚îî‚îÄ ChatRequest: "T√¥i mu·ªën xem c√°c l·∫ßn ƒëƒÉng nh·∫≠p th·∫•t b·∫°i"
        ‚îÇ
        ‚îî‚îÄ AiComparisonService.handleRequestWithComparison()
           ‚îÇ
           ‚îú‚îÄ buildDynamicExamples(userQuery)
           ‚îÇ  ‚îÇ
           ‚îÇ  ‚îî‚îÄ VectorSearchService.findRelevantExamples()
           ‚îÇ     ‚îÇ
           ‚îÇ     ‚îî‚îÄ vectorStore.similaritySearch(userQuery)
           ‚îÇ        ‚îÇ
           ‚îÇ        ‚îú‚îÄ Step 1: Embed query ‚Üí Vector[1536]
           ‚îÇ        ‚îÇ
           ‚îÇ        ‚îú‚îÄ Step 2: Compare with 2300 stored vectors
           ‚îÇ        ‚îÇ  ‚îú‚îÄ Doc 1: similarity = 0.9871
           ‚îÇ        ‚îÇ  ‚îú‚îÄ Doc 2: similarity = 0.9854
           ‚îÇ        ‚îÇ  ‚îú‚îÄ ...
           ‚îÇ        ‚îÇ  ‚îî‚îÄ Sort by score
           ‚îÇ        ‚îÇ
           ‚îÇ        ‚îî‚îÄ Step 3: Return top 5 documents
           ‚îÇ
           ‚îú‚îÄ Format as String examples
           ‚îÇ
           ‚îú‚îÄ Create Full Prompt
           ‚îÇ  "You are expert... Here are examples: {...}"
           ‚îÇ
           ‚îî‚îÄ Send to LLM (OpenAI/OpenRouter)
              ‚îÇ
              ‚îî‚îÄ Return Elasticsearch query
```

---

## üìå T√≥m T·∫Øt

```
User Query (t·ª± nhi√™n)
   ‚Üì
Embedding Model chuy·ªÉn th√†nh Vector 1536-chi·ªÅu
   ‚Üì
So s√°nh v·ªõi 2300 stored vectors
   ‚Üì
Calculate Cosine Similarity cho m·ªói c√°i
   ‚Üì
Sort v√† l·∫•y Top 5 k·∫øt qu·∫£ t∆∞∆°ng ƒë·ªìng nh·∫•t
   ‚Üì
Format th√†nh String examples
   ‚Üì
Th√™m v√†o LLM Prompt
   ‚Üì
LLM xem examples v√† t·∫°o query t·ªët h∆°n
   ‚Üì
Return Elasticsearch query cho user
```

---

**Generated:** 2025-10-22  
**Reference:** Spring AI + Vector Database
