# ğŸ’¬ BÆ¯á»šC 1: Request Processing & Save User Message - Sequence Diagram

## ğŸ“‹ Tá»•ng Quan

TÃ i liá»‡u nÃ y mÃ´ táº£ quy trÃ¬nh lÆ°u tin nháº¯n cá»§a ngÆ°á»i dÃ¹ng vÃ o database trÆ°á»›c khi xá»­ lÃ½ comparison mode.

## ğŸ“Š Sequence Diagram

### CÃ¡ch xem diagram:
1. **Mermaid (GitHub/GitLab tá»± Ä‘á»™ng render)**: Diagram sáº½ tá»± Ä‘á»™ng render trong file `.md`
2. **Online Mermaid Editor**: https://mermaid.live
3. **VS Code**: CÃ i extension "Markdown Preview Mermaid Support"

---

## ğŸ¨ Mermaid Sequence Diagram

```mermaid
sequenceDiagram
    participant UI as ğŸŒ UI
    participant Controller as ğŸ“¡ ChatMessagesController
    participant Service as ğŸ’¼ ChatMessagesService
    participant Repository as ğŸ—„ï¸ ChatMessagesRepository
    participant Database as ğŸ’¾ Database

    Note over UI,Database: BÆ¯á»šC 1: Request Processing & Save User Message

    UI->>Controller: POST /api/chat-messages/compare/{sessionId}<br/>ChatRequest with user message
    
    Controller->>Controller: Log request info<br/>(sessionId + message content)
    
    Controller->>Controller: Create ChatMessages entity<br/>sender = USER<br/>content = message
    
    Controller->>Service: saveWithoutAiResponse<br/>(sessionId, userMessage)
    Note right of Service: Skip AI auto-response
    
    Service->>Service: Validate session & message<br/>(findById(sessionId))
    Service->>Service: setChatSessions(chatSessions)
    
    Service->>Repository: save(chatMessages)
    Repository->>Database: INSERT INTO chat_messages<br/>(session_id, sender, content, timestamp)
    Database-->>Repository: saved message with ID
    Repository-->>Service: saved user message
    
    Service-->>Controller: ChatMessages (savedUserMessage)
    
    Controller->>Controller: Store savedUserMessage.getMessageId()<br/>For final response metadata
    
    Note over Controller: Ready for next step<br/>(Comparison mode processing)
```

---

## ğŸ“ Chi Tiáº¿t Quy TrÃ¬nh

### 1. UI Gá»­i Request
- **Method**: `POST`
- **Endpoint**: `/api/chat-messages/compare/{sessionId}`
- **Request Body**:
  ```json
  {
    "message": "User's question or message"
  }
  ```
- **Path Variable**: `sessionId` - ID cá»§a chat session

### 2. ChatMessagesController Nháº­n Request

#### 2.1. Log Request Info
- Log: "Báº¯t Ä‘áº§u cháº¿ Ä‘á»™ so sÃ¡nh cho phiÃªn: [sessionId]"
- Log: "Tin nháº¯n ngÆ°á»i dÃ¹ng: [message]"

#### 2.2. Create ChatMessages Entity
- `new ChatMessages()`: Táº¡o instance má»›i
- `setSender(ChatMessages.SenderType.USER)`: Äáº·t sender lÃ  USER
- `setContent(chatRequest.message())`: Äáº·t ná»™i dung tá»« request

### 3. ChatMessagesService Xá»­ LÃ½

#### 3.1. Validate Session & Message
- `chatSessionsRepository.findById(sessionId)`: TÃ¬m session trong database
- Kiá»ƒm tra session cÃ³ tá»“n táº¡i khÃ´ng
- `chatMessages.setChatSessions(chatSessions)`: GÃ¡n session vÃ o message

#### 3.2. Save Message
- Gá»i `chatMessagesRepository.save(chatMessages)`
- Repository thá»±c hiá»‡n INSERT vÃ o database

### 4. Database LÆ°u Trá»¯

#### 4.1. INSERT Statement
```sql
INSERT INTO chat_messages 
(session_id, sender, content, timestamp)
VALUES 
(?, 'USER', ?, CURRENT_TIMESTAMP)
```

#### 4.2. Return Saved Message
- Database generate `message_id` tá»± Ä‘á»™ng (IDENTITY)
- Tráº£ vá» `ChatMessages` object vá»›i `messageId` Ä‘Ã£ Ä‘Æ°á»£c set

### 5. Controller LÆ°u Metadata

#### 5.1. Store Message ID
- `savedUserMessage.getMessageId()`: LÆ°u message ID Ä‘á»ƒ sá»­ dá»¥ng sau
- Log: "ÄÃ£ lÆ°u tin nháº¯n ngÆ°á»i dÃ¹ng vá»›i ID: [messageId]"

#### 5.2. Prepare for Next Step
- Chuáº©n bá»‹ metadata cho response cuá»‘i cÃ¹ng
- Sáºµn sÃ ng cho bÆ°á»›c tiáº¿p theo (Comparison mode processing)

---

## ğŸ”„ Data Flow

```
UI Request
    â†“
ChatMessagesController
    â”œâ”€â†’ Log request info
    â”œâ”€â†’ Create ChatMessages entity
    â”‚   â”œâ”€ sender = USER
    â”‚   â””â”€ content = message
    â””â”€â†’ Call Service
        â†“
ChatMessagesService
    â”œâ”€â†’ Validate session (findById)
    â”œâ”€â†’ Set chatSessions relationship
    â””â”€â†’ Call Repository
        â†“
ChatMessagesRepository
    â””â”€â†’ Call Database
        â†“
Database
    â”œâ”€â†’ INSERT message
    â”œâ”€â†’ Generate messageId
    â””â”€â†’ Return saved message
        â†“
Return to Controller
    â””â”€â†’ Store messageId for metadata
```

---

## ğŸ—„ï¸ Database Schema

### Table: chat_messages
```sql
CREATE TABLE chat_messages (
  message_id BIGINT GENERATED BY DEFAULT AS IDENTITY,
  session_id BIGINT NOT NULL,
  sender VARCHAR(10) NOT NULL CHECK (sender IN ('USER', 'AI')),
  content TEXT NOT NULL,
  timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (message_id),
  CONSTRAINT fk_message_session
    FOREIGN KEY (session_id)
    REFERENCES chat_sessions (session_id)
    ON DELETE CASCADE
);
```

### INSERT Statement
```sql
INSERT INTO chat_messages 
(session_id, sender, content, timestamp)
VALUES 
(:sessionId, 'USER', :content, CURRENT_TIMESTAMP)
```

---

## ğŸ“¡ API Endpoint

### POST /api/chat-messages/compare/{sessionId}
**MÃ´ táº£**: LÆ°u tin nháº¯n cá»§a user vÃ  xá»­ lÃ½ comparison mode

**Path Variables**:
- `sessionId` (Long): ID cá»§a chat session

**Request Body**:
```json
{
  "message": "User's question or message"
}
```

**Response**: 
- Response sáº½ Ä‘Æ°á»£c tráº£ vá» sau khi xá»­ lÃ½ comparison mode hoÃ n táº¥t
- Message ID Ä‘Æ°á»£c lÆ°u trong metadata: `saved_user_message_id`

---

## ğŸ”‘ Key Points

### Skip AI Auto-Response
- Method `saveWithoutAiResponse()` Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ **KHÃ”NG** tá»± Ä‘á»™ng táº¡o AI response
- AI response sáº½ Ä‘Æ°á»£c táº¡o riÃªng trong comparison mode
- TrÃ¡nh duplicate AI calls

### Session Validation
- Service validate session tá»“n táº¡i trÆ°á»›c khi lÆ°u message
- Náº¿u session khÃ´ng tá»“n táº¡i, sáº½ throw exception

### Message ID Storage
- Message ID Ä‘Æ°á»£c lÆ°u Ä‘á»ƒ:
  - ThÃªm vÃ o response metadata
  - Link vá»›i AI responses sau nÃ y
  - Tracking vÃ  debugging

---

## ğŸ¨ Draw.io Instructions

### CÃ¡ch táº¡o sequence diagram trong Draw.io:

1. **Má»Ÿ Draw.io**: https://app.diagrams.net/

2. **Táº¡o diagram má»›i**: File â†’ New â†’ Blank Diagram

3. **Chá»n template**: 
   - More Shapes â†’ UML â†’ Sequence
   - Hoáº·c tÃ¬m "Sequence" trong template gallery

4. **ThÃªm participants (Lifelines)**:
   - KÃ©o tháº£ "Lifeline" cho má»—i participant:
     - UI
     - ChatMessagesController
     - ChatMessagesService
     - ChatMessagesRepository
     - Database

5. **ThÃªm messages**:
   - DÃ¹ng "Message" arrow (solid line) cho synchronous calls
   - DÃ¹ng "Return Message" arrow (dashed line) cho return values
   - Label messages vá»›i mÃ´ táº£ chi tiáº¿t

6. **ThÃªm self-loops**:
   - DÃ¹ng "Self Message" Ä‘á»ƒ chá»‰ internal operations
   - Label: "Log request info", "Create ChatMessages entity", etc.

7. **ThÃªm notes**:
   - DÃ¹ng "Note" shape Ä‘á»ƒ thÃªm ghi chÃº
   - Note: "Skip AI auto-response"
   - Note: "Ready for next step"

8. **ThÃªm activation boxes**:
   - DÃ¹ng "Activation" box Ä‘á»ƒ chá»‰ execution time
   - Hiá»ƒn thá»‹ khi component Ä‘ang xá»­ lÃ½

9. **Styling**:
   - Messages: MÃ u Ä‘en (solid) hoáº·c xanh (dashed)
   - Notes: MÃ u vÃ ng nháº¡t
   - Activation boxes: MÃ u xÃ¡m nháº¡t

10. **LÆ°u file**: 
    - File â†’ Save As â†’ `save_user_message_sequence.drawio`
    - Hoáº·c export as PNG/PDF

---

## ğŸ“ Notes

- **No AI Response**: Method nÃ y chá»‰ lÆ°u user message, khÃ´ng táº¡o AI response
- **Session Validation**: Service validate session tá»“n táº¡i trÆ°á»›c khi lÆ°u
- **Foreign Key**: Message Ä‘Æ°á»£c link vá»›i session qua `session_id`
- **Auto Timestamp**: Database tá»± Ä‘á»™ng set `timestamp` khi INSERT
- **Message ID**: ÄÆ°á»£c generate tá»± Ä‘á»™ng bá»Ÿi database (IDENTITY)
- **Next Step**: Sau khi lÆ°u user message, sáº½ tiáº¿p tá»¥c vá»›i comparison mode processing

