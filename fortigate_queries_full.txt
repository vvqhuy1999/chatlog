1) “Trong 24 giờ qua, những IP nguồn nào bị chặn (deny) nhiều nhất?”
{
  "index": "logs-fortinet_fortigate.log-default*",
  "size": 0,
  "query": {
    "bool": {
      "filter": [
        { "term": { "fortinet.firewall.action": "deny" } },
        { "range": { "@timestamp": { "gte": "now-24h" } } }
      ]
    }
  },
  "aggs": {
    "top_blocked_sources": {
      "terms": { "field": "source.ip", "size": 10 }
    }
  }
}

2) “Từ IP nguồn 192.0.2.10, đích nào nhận nhiều bytes nhất trong 24 giờ qua?”
{
  "index": "logs-fortinet_fortigate.log-default*",
  "size": 0,
  "query": {
    "bool": {
      "filter": [
        { "term": { "source.ip": "192.0.2.10" } },
        { "range": { "@timestamp": { "gte": "now-24h" } } }
      ]
    }
  },
  "aggs": {
    "by_dst": {
      "terms": { "field": "destination.ip", "size": 10, "order": { "bytes_sum": "desc" } },
      "aggs": {
        "bytes_sum": { "sum": { "field": "network.bytes" } }
      }
    }
  }
}

3) “Liệt kê các phiên có mức rủi ro IPS cao (crlevel = high/critical) trong 1 ngày qua.”
{
  "index": "logs-fortinet_fortigate.log-default*",
  "size": 50,
  "sort": [ { "@timestamp": "desc" } ],
  "query": {
    "bool": {
      "filter": [
        { "terms": { "fortinet.firewall.crlevel": ["high", "critical"] } },
        { "range": { "@timestamp": { "gte": "now-24h" } } }
      ]
    }
  }
}

4) “Trong 7 ngày qua, các kết nối outbound từ Việt Nam ra nước ngoài (không phải Việt Nam) là gì?”
{
  "index": "logs-fortinet_fortigate.log-default*",
  "size": 100,
  "query": {
    "bool": {
      "must": [
        { "term": { "network.direction": "outbound" } },
        { "term": { "source.geo.country_name": "Vietnam" } }
      ],
      "must_not": [
        { "term": { "destination.geo.country_name": "Vietnam" } }
      ],
      "filter": [
        { "range": { "@timestamp": { "gte": "now-7d" } } }
      ]
    }
  }
}

5) “Có những lần đăng nhập thất bại của người dùng ‘alice’ trong 48 giờ qua không?”
{
  "index": "logs-fortinet_fortigate.log-default*",
  "size": 100,
  "sort": [ { "@timestamp": "desc" } ],
  "query": {
    "bool": {
      "must": [
        { "term": { "source.user.name": "alice" } },
        { "term": { "event.action": "login" } },
        { "term": { "event.outcome": "failure" } }
      ],
      "filter": [
        { "range": { "@timestamp": { "gte": "now-48h" } } }
      ]
    }
  }
}

6) “Những rule nào chặn nhiều nhất trong 24 giờ qua?”
{
  "index": "logs-fortinet_fortigate.log-default*",
  "size": 0,
  "query": {
    "bool": {
      "filter": [
        { "term": { "fortinet.firewall.action": "deny" } },
        { "range": { "@timestamp": { "gte": "now-24h" } } }
      ]
    }
  },
  "aggs": {
    "rules": {
      "terms": { "field": "rule.name", "size": 10 }
    }
  }
}

7) “Trong 1 giờ qua, có lưu lượng RDP (port 3389) đi vào từ WAN không?”
{
  "index": "logs-fortinet_fortigate.log-default*",
  "size": 100,
  "sort": [ { "@timestamp": "desc" } ],
  "query": {
    "bool": {
      "filter": [
        { "term": { "destination.port": 3389 } },
        { "term": { "fortinet.firewall.srcintfrole": "wan" } },
        { "range": { "@timestamp": { "gte": "now-1h" } } }
      ]
    }
  }
}

8) “Các phiên DNAT tới server nội bộ 10.0.0.10 trong 24 giờ gần đây là gì?”
{
  "index": "logs-fortinet_fortigate.log-default*",
  "size": 100,
  "sort": [ { "@timestamp": "desc" } ],
  "query": {
    "bool": {
      "filter": [
        { "term": { "fortinet.firewall.trandisp": "dnat" } },
        { "term": { "destination.ip": "10.0.0.10" } },
        { "range": { "@timestamp": { "gte": "now-24h" } } }
      ]
    }
  }
}

9) “Trong 1 giờ qua, IP nguồn nào gửi nhiều gói ICMP bất thường (> 10.000 packets)?”
{
  "index": "logs-fortinet_fortigate.log-default*",
  "size": 0,
  "query": {
    "bool": {
      "filter": [
        { "term": { "network.protocol": "icmp" } },
        { "range": { "@timestamp": { "gte": "now-1h" } } }
      ]
    }
  },
  "aggs": {
    "by_source": {
      "terms": { "field": "source.ip", "size": 50 },
      "aggs": {
        "pkt_sum": { "sum": { "field": "network.packets" } },
        "heavy_senders": {
          "bucket_selector": {
            "buckets_path": { "p": "pkt_sum" },
            "script": "params.p > 10000"
          }
        }
      }
    }
  }
}

10) “Có traffic bị ‘drop’ bởi policy shaping tên ‘Limit-Guest’ trên thiết bị FGT-01 trong 24 giờ qua không?”
{
  "index": "logs-fortinet_fortigate.log-default*",
  "size": 100,
  "sort": [ { "@timestamp": "desc" } ],
  "query": {
    "bool": {
      "must": [
        { "term": { "observer.name": "FGT-01" } },
        { "term": { "fortinet.firewall.shapingpolicyname": "Limit-Guest" } }
      ],
      "filter": [
        { "term": { "fortinet.firewall.action": "deny" } },
        { "range": { "@timestamp": { "gte": "now-24h" } } }
      ]
    }
  }
}

11) “Ai đã đăng nhập vào thiết bị Fortigate bằng tài khoản admin trong 24 giờ qua?”
{
  "index": "logs-fortinet_fortigate.log-default*",
  "size": 50,
  "sort": [{ "@timestamp": "desc" }],
  "query": {
    "bool": {
      "must": [
        { "term": { "source.user.name": "admin" } },
        { "term": { "event.action": "login" } }
      ],
      "filter": [
        { "range": { "@timestamp": { "gte": "now-24h" } } }
      ]
    }
  }
}

12) “Có phiên đăng nhập quản trị thất bại (admin login failed) nào trong 1 giờ qua không?”
{
  "index": "logs-fortinet_fortigate.log-default*",
  "size": 50,
  "sort": [{ "@timestamp": "desc" }],
  "query": {
    "bool": {
      "must": [
        { "term": { "event.action": "login" } },
        { "term": { "event.outcome": "failure" } },
        { "term": { "source.user.name": "admin" } }
      ],
      "filter": [
        { "range": { "@timestamp": { "gte": "now-1h" } } }
      ]
    }
  }
}

13) “Trong 7 ngày qua có thay đổi nào về rule firewall không?”
{
  "index": "logs-fortinet_fortigate.log-default*",
  "size": 100,
  "sort": [{ "@timestamp": "desc" }],
  "query": {
    "bool": {
      "must": [
        { "term": { "event.type": "configuration" } },
        { "term": { "rule.ruleset": "firewall" } }
      ],
      "filter": [
        { "range": { "@timestamp": { "gte": "now-7d" } } }
      ]
    }
  }
}

14) “Ai đã thay đổi cấu hình hệ thống trong 24 giờ qua?”
{
  "index": "logs-fortinet_fortigate.log-default*",
  "size": 100,
  "query": {
    "bool": {
      "must": [
        { "term": { "event.type": "configuration" } }
      ],
      "filter": [
        { "range": { "@timestamp": { "gte": "now-24h" } } }
      ]
    }
  },
  "aggs": {
    "by_user": {
      "terms": { "field": "source.user.name", "size": 10 }
    }
  }
}

15) “Có đăng nhập quản trị nào từ quốc gia khác Việt Nam trong 48 giờ qua?”
{
  "index": "logs-fortinet_fortigate.log-default*",
  "size": 50,
  "query": {
    "bool": {
      "must": [
        { "term": { "event.action": "login" } },
        { "term": { "fortinet.firewall.srcintfrole": "wan" } }
      ],
      "must_not": [
        { "term": { "source.geo.country_name": "Vietnam" } }
      ],
      "filter": [
        { "range": { "@timestamp": { "gte": "now-48h" } } }
      ]
    }
  }
}

16) “Trong 24 giờ qua có ai bật/tắt tính năng IPS hoặc AV không?”
{
  "index": "logs-fortinet_fortigate.log-default*",
  "size": 50,
  "query": {
    "bool": {
      "must": [
        { "term": { "event.type": "configuration" } },
        { "terms": { "rule.category": ["IPS", "Antivirus"] } }
      ],
      "filter": [
        { "range": { "@timestamp": { "gte": "now-24h" } } }
      ]
    }
  }
}

17) “Có dấu hiệu brute-force login (quá nhiều login failure từ 1 IP) trong 1 giờ qua không?”
{
  "index": "logs-fortinet_fortigate.log-default*",
  "size": 0,
  "query": {
    "bool": {
      "must": [
        { "term": { "event.action": "login" } },
        { "term": { "event.outcome": "failure" } }
      ],
      "filter": [
        { "range": { "@timestamp": { "gte": "now-1h" } } }
      ]
    }
  },
  "aggs": {
    "by_ip": {
      "terms": { "field": "source.ip", "size": 20 },
      "aggs": {
        "fail_count": { "value_count": { "field": "event.outcome" } },
        "brute_force": {
          "bucket_selector": {
            "buckets_path": { "c": "fail_count" },
            "script": "params.c > 10"
          }
        }
      }
    }
  }
}

18) “Có IP nào thực hiện quá nhiều kết nối đến port quản trị (443, 22) trong 15 phút gần đây không?”
{
  "index": "logs-fortinet_fortigate.log-default*",
  "size": 0,
  "query": {
    "bool": {
      "filter": [
        { "terms": { "destination.port": [22, 443] } },
        { "range": { "@timestamp": { "gte": "now-15m" } } }
      ]
    }
  },
  "aggs": {
    "by_src": {
      "terms": { "field": "source.ip", "size": 20 },
      "aggs": {
        "conn_count": { "value_count": { "field": "destination.port" } },
        "suspicious": {
          "bucket_selector": {
            "buckets_path": { "c": "conn_count" },
            "script": "params.c > 50"
          }
        }
      }
    }
  }
}

19) “Ai đã thay đổi policy shaping trong 7 ngày qua?”
{
  "index": "logs-fortinet_fortigate.log-default*",
  "size": 100,
  "query": {
    "bool": {
      "must": [
        { "term": { "event.type": "configuration" } },
        { "exists": { "field": "fortinet.firewall.shapingpolicyname" } }
      ],
      "filter": [
        { "range": { "@timestamp": { "gte": "now-7d" } } }
      ]
    }
  },
  "aggs": {
    "by_user": {
      "terms": { "field": "source.user.name", "size": 10 }
    }
  }
}

20) “Có thay đổi nào trong cấu hình interface WAN trong 24 giờ qua không?”
{
  "index": "logs-fortinet_fortigate.log-default*",
  "size": 50,
  "query": {
    "bool": {
      "must": [
        { "term": { "event.type": "configuration" } }
      ],
      "should": [
        { "term": { "observer.ingress.interface.name": "wan" } },
        { "term": { "observer.egress.interface.name": "wan" } }
      ],
      "minimum_should_match": 1,
      "filter": [
        { "range": { "@timestamp": { "gte": "now-24h" } } }
      ]
    }
  }
}

21) “Trong 24 giờ qua, những user nào bị chặn khi cố gắng kết nối SSH?”
{
  "index": "logs-fortinet_fortigate.log-default*",
  "size": 0,
  "query": {
    "bool": {
      "filter": [
        { "term": { "destination.port": 22 } },
        { "term": { "fortinet.firewall.action": "deny" } },
        { "range": { "@timestamp": { "gte": "now-24h" } } }
      ]
    }
  },
  "aggs": {
    "blocked_users": {
      "terms": { "field": "source.user.name", "size": 10 }
    }
  }
}

22) “Có user nào bị chặn khi truy cập RDP (3389) từ LAN ra ngoài internet không?”
{
  "index": "logs-fortinet_fortigate.log-default*",
  "size": 50,
  "query": {
    "bool": {
      "must": [
        { "term": { "destination.port": 3389 } },
        { "term": { "fortinet.firewall.action": "deny" } },
        { "term": { "fortinet.firewall.srcintfrole": "lan" } }
      ],
      "filter": [
        { "range": { "@timestamp": { "gte": "now-24h" } } }
      ]
    }
  }
}

23) “Trong 1 giờ qua có user nào gửi nhiều gói ICMP bị chặn?”
{
  "index": "logs-fortinet_fortigate.log-default*",
  "size": 0,
  "query": {
    "bool": {
      "filter": [
        { "term": { "network.protocol": "icmp" } },
        { "term": { "fortinet.firewall.action": "deny" } },
        { "range": { "@timestamp": { "gte": "now-1h" } } }
      ]
    }
  },
  "aggs": {
    "blocked_icmp": {
      "terms": { "field": "source.user.name", "size": 10 },
      "aggs": {
        "pkt_sum": { "sum": { "field": "network.packets" } }
      }
    }
  }
}

24) “Những user nào cố gắng quét port (nhiều destination.port khác nhau) trong 15 phút gần đây?”
{
  "index": "logs-fortinet_fortigate.log-default*",
  "size": 0,
  "query": {
    "bool": {
      "filter": [
        { "range": { "@timestamp": { "gte": "now-15m" } } }
      ]
    }
  },
  "aggs": {
    "by_user": {
      "terms": { "field": "source.user.name", "size": 20 },
      "aggs": {
        "unique_ports": { "cardinality": { "field": "destination.port" } },
        "port_scan": {
          "bucket_selector": {
            "buckets_path": { "p": "unique_ports" },
            "script": "params.p > 10"
          }
        }
      }
    }
  }
}

25) “Có user nào bị chặn khi tải file qua FTP (port 21) không?”
{
  "index": "logs-fortinet_fortigate.log-default*",
  "size": 50,
  "query": {
    "bool": {
      "must": [
        { "term": { "destination.port": 21 } },
        { "term": { "fortinet.firewall.action": "deny" } }
      ],
      "filter": [
        { "range": { "@timestamp": { "gte": "now-24h" } } }
      ]
    }
  }
}

26) “Trong 7 ngày qua, user nào bị chặn nhiều nhất vì truy cập web không hợp lệ?”
{
  "index": "logs-fortinet_fortigate.log-default*",
  "size": 0,
  "query": {
    "bool": {
      "must": [
        { "term": { "fortinet.firewall.subtype": "webfilter" } },
        { "term": { "fortinet.firewall.action": "deny" } }
      ],
      "filter": [
        { "range": { "@timestamp": { "gte": "now-7d" } } }
      ]
    }
  },
  "aggs": {
    "top_users": {
      "terms": { "field": "source.user.name", "size": 10 }
    }
  }
}

27) “Có user nào kết nối đến quốc gia bị hạn chế (ví dụ: Russia, China) trong 24 giờ qua không?”
{
  "index": "logs-fortinet_fortigate.log-default*",
  "size": 50,
  "query": {
    "bool": {
      "must": [
        { "terms": { "destination.geo.country_name": ["Russia", "China"] } }
      ],
      "filter": [
        { "range": { "@timestamp": { "gte": "now-24h" } } }
      ]
    }
  }
}

28) “Trong 1 giờ qua có user nào upload quá nhiều dữ liệu ra ngoài (>1GB) không?”
{
  "index": "logs-fortinet_fortigate.log-default*",
  "size": 0,
  "query": {
    "bool": {
      "must": [
        { "term": { "network.direction": "outbound" } }
      ],
      "filter": [
        { "range": { "@timestamp": { "gte": "now-1h" } } }
      ]
    }
  },
  "aggs": {
    "by_user": {
      "terms": { "field": "source.user.name", "size": 20 },
      "aggs": {
        "bytes_sent": { "sum": { "field": "network.bytes" } },
        "big_upload": {
          "bucket_selector": {
            "buckets_path": { "b": "bytes_sent" },
            "script": "params.b > 1073741824"
          }
        }
      }
    }
  }
}

29) “Có user nào trong LAN cố gắng truy cập dịch vụ quản trị web của Fortigate (port 443) bị chặn?”
{
  "index": "logs-fortinet_fortigate.log-default*",
  "size": 50,
  "query": {
    "bool": {
      "must": [
        { "term": { "destination.port": 443 } },
        { "term": { "fortinet.firewall.action": "deny" } },
        { "term": { "fortinet.firewall.srcintfrole": "lan" } }
      ],
      "filter": [
        { "range": { "@timestamp": { "gte": "now-24h" } } }
      ]
    }
  }
}

30) “Trong 24 giờ qua, có user nào bị chặn khi dùng ứng dụng P2P (torrent) không?”
{
  "index": "logs-fortinet_fortigate.log-default*",
  "size": 50,
  "query": {
    "bool": {
      "must": [
        { "term": { "rule.category": "p2p" } },
        { "term": { "fortinet.firewall.action": "deny" } }
      ],
      "filter": [
        { "range": { "@timestamp": { "gte": "now-24h" } } }
      ]
    }
  }
}
