[2025-11-15 22:02:52.914] [SUCCESS_DETAILED] [AiComparisonService] ✅ Xử lý thành công yêu cầu song song OpenAI và OpenRouter (tiết kiệm 24064ms)
════════════════════════════ SUCCESS DETAILS ════════════════════════════
▶ CONTEXT:
   - userMessage: có ai chỉnh sửa hệ thống trong 3 ngày gần đây không
   - timeSavedMs: 24064
   - aiSummary: {openrouter_esSuccess=true, openai_esSuccess=true, openrouter_totalMs=27782, openai_totalMs=30010, openrouter_searchMs=0, openai_searchMs=0}
   - sessionId: 284
   - totalProcessingTimeMs: 33728

▶ DSL QUERIES:
   OpenAI DSL: {"size":50,"query":{"bool":{"filter":[{"range":{"@timestamp":{"gte":"now-3d"}}},{"term":{"fortinet.firewall.action":"Edit"}}]}}}
   OpenRouter DSL: {"size":50,"query":{"bool":{"filter":[{"range":{"@timestamp":{"gte":"now-3d"}}},{"terms":{"fortinet.firewall.action":["Edit","Add","Delete"]}}]}}}

▶ ES DATA (FULL, truncated):
   OpenAI Data: Data retrieved
   OpenRouter Data: Data retrieved

▶ AI RESULTS SUMMARY:
   - openrouter_esSuccess: true
   - openai_esSuccess: true
   - openrouter_totalMs: 27782
   - openai_totalMs: 30010
   - openrouter_searchMs: 0
   - openai_searchMs: 0

▶ DYNAMIC EXAMPLES (Vector Search):
RELEVANT EXAMPLES FROM KNOWLEDGE BASE
   Mode: VECTOR
   
   Example 1:
   Question: Các cập nhật hệ thống trong tuần này
   Content: Các cập nhật hệ thống trong tuần này
   Query: {"size":50,"sort":[{"@timestamp":"desc"}],"query":{"bool":{"filter":[{"term":{"fortinet.firewall.action":"update"}},{"range":{"@timestamp":{"gte":"now-7d"}}}]}}}
   
   Example 2:
   Question: Lấy 100 log mới nhất trong khoảng từ 8h đến 9h sáng ngày 08/10/2025
   Content: Lấy 100 log mới nhất trong khoảng từ 8h đến 9h sáng ngày 08/10/2025
   Query: {"query":{"range":{"@timestamp":{"gte":"2025-10-08T08:00:00.000+07:00","lt":"2025-10-08T09:00:00.000+07:00"}}},"size":100,"sort":[{"@timestamp":"desc"}]}
   
   Example 3:
   Question: Các lỗi hệ thống trong tuần này
   Content: Các lỗi hệ thống trong tuần này
   Query: {"size":100,"sort":[{"@timestamp":"desc"}],"query":{"bool":{"filter":[{"term":{"fortinet.firewall.action":"error"}},{"range":{"@timestamp":{"gte":"now/w"}}}]}}}
   
   Example 4:
   Question: Danh sách cấu hình mới được thêm vào trong tháng này
   Content: Danh sách cấu hình mới được thêm vào trong tháng này
   Query: {"size":100,"sort":[{"@timestamp":"desc"}],"_source":["@timestamp","source.user.name","message","observer.name","observer.serial_number","fortinet.firewall.action","fortinet.firewall.cfgattr","fortinet.firewall.cfgobj","fortinet.firewall.cfgpath","fortinet.firewall.ui"],"query":{"bool":{"filter":[{"term":{"fortinet.firewall.action":"Add"}},{"range":{"@timestamp":{"gte":"now/M"}}}]}}}
   
   Example 5:
   Question: Hiển thị các hoạt động từ 22h đêm ngày 05/10/2025 đến 1h sáng ngày 06/10/2025
   Content: Hiển thị các hoạt động từ 22h đêm ngày 05/10/2025 đến 1h sáng ngày 06/10/2025
   Query: {"query":{"range":{"@timestamp":{"gte":"2025-10-05T22:00:00.000+07:00","lt":"2025-10-06T01:00:00.000+07:00"}}},"size":50,"sort":[{"@timestamp":"desc"}]}
   
   Example 6:
   Question: Các mối đe dọa được phát hiện trong 24 giờ qua
   Content: Các mối đe dọa được phát hiện trong 24 giờ qua
   Query: {"size":100,"sort":[{"@timestamp":"desc"}],"query":{"bool":{"filter":[{"term":{"fortinet.firewall.action":"detected"}},{"range":{"@timestamp":{"gte":"now-24h"}}}]}}}
   
   Example 7:
   Question: Hiển thị 20 log trong khoảng 15:00 đến 15:15 ngày 08/10/2025
   Content: Hiển thị 20 log trong khoảng 15:00 đến 15:15 ngày 08/10/2025
   Query: {"query":{"range":{"@timestamp":{"gte":"2025-10-08T15:00:00.000+07:00","lt":"2025-10-08T15:15:00.000+07:00"}}},"size":20,"sort":[{"@timestamp":"desc"}]}
   
   Example 8:
   Question: Micro-segmentation: Lưu lượng East-West không được phép giữa các vùng mạng?
   Content: Micro-segmentation: Lưu lượng East-West không được phép giữa các vùng mạng?
   Query: {"query":{"bool":{"filter":[{"range":{"@timestamp":{"gte":"now-1h"}}},{"term":{"network.direction":"internal"}},{"term":{"fortinet.firewall.action":"accept"}},{"bool":{"should":[{"bool":{"must":[{"term":{"fortinet.firewall.srcintfrole":"lan"}},{"term":{"fortinet.firewall.dstintfrole":"dmz"}}]}},{"bool":{"must":[{"term":{"fortinet.firewall.srcintfrole":"dmz"}},{"term":{"fortinet.firewall.dstintfrole":"l...
   (truncated - see full output in console)

▶ TIMESTAMP: 2025-11-15T22:02:52.9144363
════════════════════════════ END SUCCESS DETAILS ════════════════════════════

[2025-11-15 22:03:53.758] [SUCCESS_DETAILED] [AiComparisonService] ✅ Xử lý thành công yêu cầu song song OpenAI và OpenRouter (tiết kiệm 26894ms)
════════════════════════════ SUCCESS DETAILS ════════════════════════════
▶ CONTEXT:
   - userMessage: bạn có thể đưa ra chi tiết thêm nữa được ko?
   - timeSavedMs: 26894
   - aiSummary: {openrouter_esSuccess=true, openai_esSuccess=true, openrouter_totalMs=31552, openai_totalMs=30046, openrouter_searchMs=0, openai_searchMs=0}
   - sessionId: 284
   - totalProcessingTimeMs: 34704

▶ DSL QUERIES:
   OpenAI DSL: {"size":50,"query":{"bool":{"filter":[{"range":{"@timestamp":{"gte":"now-3d"}}},{"term":{"fortinet.firewall.action":"Edit"}}]}}}
   OpenRouter DSL: {"size":100,"query":{"bool":{"filter":[{"range":{"@timestamp":{"gte":"now-3d"}}},{"terms":{"fortinet.firewall.action":["Edit","Add","Delete"]}}]}},"sort":[{"@timestamp":"desc"}]}

▶ ES DATA (FULL, truncated):
   OpenAI Data: Data retrieved
   OpenRouter Data: Data retrieved

▶ AI RESULTS SUMMARY:
   - openrouter_esSuccess: true
   - openai_esSuccess: true
   - openrouter_totalMs: 31552
   - openai_totalMs: 30046
   - openrouter_searchMs: 0
   - openai_searchMs: 0

▶ DYNAMIC EXAMPLES (Vector Search):
RELEVANT EXAMPLES FROM KNOWLEDGE BASE
   Mode: VECTOR
   
   Example 1:
   Question: Tấn công Pass-the-Hash: Xác thực từ các workstation bất thường?
   Content: Tấn công Pass-the-Hash: Xác thực từ các workstation bất thường?
   Query: {"query":{"bool":{"filter":[{"range":{"@timestamp":{"gte":"now-24h"}}},{"term":{"event.action":"authentication"}}]}},"aggs":{"by_user":{"terms":{"field":"source.user.name","size":50},"aggs":{"workstation_diversity":{"cardinality":{"field":"source.hostname"}},"auth_methods":{"terms":{"field":"fortinet.firewall.authmethod"}},"unusual_workstations":{"bucket_selector":{"buckets_path":{"diversity":"workstation_diversity"},"script":"params.diversity > 5"}}}}}}
   
   Example 2:
   Question: Dòng thời gian đầy đủ các hoạt động của user nguyenvana trong 7 ngày qua?
   Content: Dòng thời gian đầy đủ các hoạt động của user nguyenvana trong 7 ngày qua?
   Query: {"query":{"bool":{"filter":[{"term":{"source.user.name":"nguyenvana"}},{"range":{"@timestamp":{"gte":"now-7d"}}}]}},"_source":["@timestamp","source.ip","source.geo.country_name","destination.ip","destination.port","event.action","rule.name","network.bytes"],"sort":[{"@timestamp":"asc"}],"size":1000}
   
   Example 3:
   Question: Top 20 tổ chức nguy hiểm với thông tin chi tiết
   Content: Top 20 tổ chức nguy hiểm với thông tin chi tiết
   Query: {"size":0,"query":{"bool":{"filter":[{"range":{"@timestamp":{"gte":"2025-10-01T00:00:00.000+07:00","lte":"2025-10-31T23:59:59.999+07:00"}}},{"term":{"network.direction":"outbound"}}],"should":[{"term":{"fortinet.firewall.action":"deny"}},{"exists":{"field":"fortinet.firewall.attack"}},{"exists":{"field":"fortinet.firewall.virus"}},{"exists":{"field":"fortinet.firewall.botnetip"}}],"minimum_should_match":1}},"aggs":{"top_dangerous_orgs":{"terms":{"field":"destination.as.organization.name","size":20},"aggs":{"total_incidents":{"value_count":{"field":"@timestamp"}},"unique_users_affected":{"cardinality":{"field":"source.user.name"}},"unique_ips":{"cardinality":{"field":"destination.ip"}},"threat_breakdown":{"filters":{"filters":{"blocked":{"term":{"fortinet.firewall.action":"deny"}},"ips_alerts":{"exists":{"field":"fortinet.firewall.attack"}},"malware":{"exists":{"field":"fortinet.firewall.virus"}},"botnet":{"exists":{"field":"fortinet.firewall.botnetip"}},"critical_ips":{"terms":{"fortinet.firewall.crlevel":["critical"]}}}}},"top_attacks":{"terms":{"field":"fortinet.firewall.attack","size":5}},"top_malware":{"terms":{"field":"fortinet.firewall.virus","size":5}},"affected_users":{"terms":{"field":"source.user.name","size":10}},"countries":{"terms":{"field":"destination.geo.country_name","size":5}},"timeline":{"date_histogram":{"field":"@timestamp","calendar_interval":"day"}}}}}}
   
   Example 4:
   Question: Tổng bandwidth sử dụng trong 1 giờ qua là bao nhiêu?
   Content: Tổng bandwidth sử dụng trong 1 giờ qua là bao nhiêu?
   Query: {"query":{"range":{"@timestamp":{"gte":"now-1h"}}},"aggs":{"total_bandwidth":{"sum":{"field":"network.bytes"}}},"size":0}
   
   Example 5:
   Question: SQL Injection at...
   (truncated - see full output in console)

▶ TIMESTAMP: 2025-11-15T22:03:53.758552
════════════════════════════ END SUCCESS DETAILS ════════════════════════════

